<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NHS Clinical Entrepreneur Programme – Digital Professional Endorsement</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{ --brand:#2563eb; --ink:#1f2937; --muted:#6b7280; --bg:#f9fafb; --line:#e5e7eb; }
*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  line-height:1.6;
}
.hidden{ display:none !important; }

.container{
  max-width:1400px;
  margin:10px auto;
  background:#fff;
  border:1px solid var(--line);
  border-radius:6px;
  box-shadow:0 1px 3px rgba(0,0,0,.06);
  overflow:hidden;
  min-height: calc(100vh - 20px);
  display:flex;
  flex-direction:column;
}
header{
  padding:16px 20px;
  border-bottom:1px solid var(--line);
  background:#000;
}
header h1{
  margin:0 0 4px;
  font-size:20px;
  font-weight:700;
  color:#fff;
}
header p{
  margin:0;
  color:#d1d5db;
  font-size:13px;
}
main{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:0;
  min-height: 0;
  flex:1;
}
.panel{
  padding:16px 20px;
  overflow:auto;
}
.left{
  border-right:1px solid var(--line);
  background: #e5e7eb;
}

.section-title{
  font-size:15px;
  font-weight:700;
  color:var(--ink);
  margin:16px 0 8px;
  padding-bottom:6px;
  border-bottom:2px solid var(--line);
}
.section-title:first-child{ margin-top:0; }

label{
  display:block;
  font-weight:500;
  margin:10px 0 4px;
  font-size:13px;
  color:var(--ink);
}
input,select,textarea{
  width:100%;
  padding:8px 10px;
  border:2px solid #0891b2;
  border-radius:4px;
  font-size:13px;
  font-family:inherit;
  background:#ffffff;
  box-shadow:0 1px 2px rgba(8,145,178,0.1);
  transition:all 0.2s;
  -webkit-appearance:none;
  -moz-appearance:none;
  appearance:none;
  min-height:37px;
}
/* Restore checkbox appearance */
input[type="checkbox"]{
  -webkit-appearance:checkbox;
  -moz-appearance:checkbox;
  appearance:checkbox;
  width:auto;
  min-height:18px;
  height:18px;
  margin:0;
  cursor:pointer;
  accent-color:#0891b2;
}

/* iOS-style toggle switches */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  vertical-align: middle;
  margin-right: 8px;
}

/* Hide default checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* Slider background */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d1d5db;
  border-radius: 24px;
  transition: 0.3s;
}

/* Circle */
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* When checked */
.switch input:checked + .slider {
  background-color: #0891b2;
}

.switch input:checked + .slider:before {
  transform: translateX(20px);
}

/* Label styling for toggles */
.toggle-label {
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  font-size: 11pt;
  color: #374151;
  user-select: none;
}
select{
  background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230891b2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat:no-repeat;
  background-position:right 8px center;
  background-size:16px;
  padding-right:32px;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#0e7490;
  box-shadow:0 0 0 2px rgba(6,182,212,0.15), 0 2px 4px rgba(8,145,178,0.12);
}
textarea{ min-height:80px; resize:vertical; }
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.col-2{ grid-column:span 2; }
small.hint{
  color:var(--muted);
  display:block;
  margin-top:3px;
  font-size:11px;
  line-height:1.3;
}
.note{
  background: linear-gradient(135deg, #dbeafe 0%, #cffafe 50%, #e9d5ff 100%);
  border:1px solid #a5b4fc;
  padding:10px 12px;
  border-radius:4px;
  font-size:12px;
  margin-bottom:12px;
  line-height:1.5;
  color:#1e293b;
}
.note a{ color:#2563eb; text-decoration:underline; }

.inline-option{
  display:flex;
  align-items:center;
  gap:6px;
  font-weight:400;
  margin-top:3px;
  font-size:12px;
}
.inline-option input{
  width:auto;
  margin:0;
}

/* Stepper nav */
.steps-nav{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.steps-nav-left{
  font-size:12px;
  font-weight:500;
  color:var(--ink);
}
.steps-nav-right{
  flex:1;
  margin-left:12px;
}
.progress-track{
  width:100%;
  height:4px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
}
.progress-bar{
  height:100%;
  width:0%;
  background:var(--brand);
  transition:width .25s ease;
}
.step-labels{
  display:flex;
  justify-content:space-between;
  margin-top:4px;
  font-size:10px;
  color:var(--muted);
}
.step-labels span.is-active{
  color:var(--brand);
  font-weight:600;
}

/* Steps */
.form-step{
  display:none;
  animation:fadeIn .2s ease;
}
.form-step.active{
  display:block;
}
@keyframes fadeIn{
  from{ opacity:0; transform:translateY(4px); }
  to{ opacity:1; transform:translateY(0); }
}

.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
button{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:4px;
  font-weight:600;
  cursor:pointer;
  font-size:13px;
  transition:background 0.2s;
}
button:hover{ background:#1d4ed8; }
button.secondary{
  background:#f3f4f6;
  color:var(--ink);
  border:1px solid var(--line);
}
button.secondary:hover{ background:#e5e7eb; }
button.ghost{
  background:#fff;
  color:#1f2937;
  border:1px solid #d1d5db;
}
button.ghost:hover{ background:#f9fafb; }

/* Signature pad - DocuSign style */
.sig-wrap{
  border:2px solid #fbbf24;
  border-radius:6px;
  background:linear-gradient(to bottom, #fffbeb 0%, #fef3c7 100%);
  padding:12px;
  position:relative;
  box-shadow:0 2px 4px rgba(251,191,36,0.2);
}
.sig-row{
  display:flex;
  gap:8px;
  align-items:center;
  margin-top:8px;
}
.sig-canvas{
  width:100%;
  height:140px;
  background:#fff;
  border:2px solid #f59e0b;
  border-radius:4px;
  position:relative;
  cursor:crosshair;
}
.sig-watermark{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  color:#d1d5db;
  font-size:16px;
  font-weight:500;
  pointer-events:none;
  user-select:none;
  display:flex;
  align-items:center;
  gap:8px;
}
.sig-watermark::before{
  content:'✕';
  font-size:24px;
  color:#f59e0b;
  font-weight:bold;
}
.sig-actions{
  display:flex;
  gap:6px;
}

/* Preview page - 1:1 scale for accurate print representation */
.preview-wrap{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding: 20px;
  width: 100%;
  min-height: 100%;
  overflow: auto;
}
.paper{
  width: 210mm;
  min-height: 297mm;
  background: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  border: 1px solid #d1d5db;
  position: relative;
  zoom: 0.65; /* Scale down to show whole page */
  transform-origin: top center;
}
.paper .page{
  padding: 15mm 20mm 20mm 20mm;
  font-family: Arial, sans-serif;
  color: #1f2937;
  line-height: 1.5;
  font-size: 11pt;
}

/* Mobile preview adjustments */
@media (max-width: 980px){
  .preview-wrap{
    padding: 10px;
    justify-content: flex-start;
  }
  .paper{
    width: 210mm;
    min-height: 297mm;
  }
  .paper .page{
    padding: 15mm 20mm;
    font-size: 11pt;
  }
}

/* Sender, header, date, recipient, subject */
.sender-block{
  font-family: Arial, sans-serif;
  font-size: 11pt;
  line-height:1.4;
  text-align:left;
  margin: 0 0 4px 0;
}
.header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}
.header-block {
  display: flex;
  justify-content: flex-end;
  padding: 0;
  font-family: Arial, sans-serif;
}
.trust-header { text-align: right; }

/* NHS logo image */
.nhs-logo-img{
  display:block;
  width:72px;      /* adjust if you want it bigger/smaller */
  height:auto;
  margin-left:auto;
}

/* trust text bits */
.trust-header .trust-name {
  font-size: 18px;
  font-weight: bold;
  margin-top: 6px;
  color: #000;
}
.trust-header .trust-sub {
  font-size: 11pt;
  font-weight: bold;
  color: #1D8FDB;
}
.trust-header .trust-hospital {
  font-size: 14px;
  font-weight: 600;
  color: #000;
  margin-top: 10px;
}
.trust-header .trust-address {
  font-size: 11pt;
  font-weight: 400;
  color: #000;
  margin-top: 6px;
  line-height: 1.4;
}

.letter-date{
  font-size: 11pt;
  margin-top: 12px;
  margin-bottom: 12px;
  text-align:left;
}

.recipient-block{
  font-size: 11pt;
  line-height: 1.4;
  margin-bottom: 8px;
}
.recipient-subject{
  font-size: 11pt;
  font-weight:bold;
  margin-bottom:12px;
}

.letter-body p{
  margin: 0 0 9pt;
}
.letter-body p.sal{
  margin-top: 10pt;
  font-weight:500;
}
.letter-closing{ margin-top: 14pt; }
.letter-sign{ margin-top: 10pt; height: 60px; }
.letter-sign img{
  max-height: 60px;
  max-width: 100%;
  object-fit: contain;
}
.letter-signoff{ margin: 8pt 0 0; }
.letter-signoff .name{ font-weight:700; }

/* Ensure all images in letter fit within A4 */
.paper .page img{
  max-width: 100%;
  height: auto;
}

/* Toast */
.toast {
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%) translateY(20px);
  background: var(--brand);
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.2);
  width: min(680px, calc(100% - 32px));
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .35s ease, transform .35s ease;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}
.toast h4 {
  margin: 0 0 4px;
  font-size: 16px;
  font-weight: 700;
}
.toast p {
  margin: 0;
  line-height: 1.45;
  font-size: 14px;
}
.toast p + p { margin-top: 4px; }
.toast em { opacity: .95; }

/* Print */
@media print{
  body{ background:#fff; }
  .container{ border:0; box-shadow:none; }
  main{ display:block; }
  .left{ display:none; }
  .panel{ padding:0; }
  .paper{ box-shadow:none; border:0; width:auto; min-height:auto; }
  .paper .page{ padding: 15mm 20mm; }
}

/* Responsive */
@media (max-width: 980px){
  main{ grid-template-columns: 1fr; }
  .left{ border-right:0; border-bottom:1px solid var(--line); }
  .grid{ grid-template-columns: 1fr; }
  .col-2{ grid-column: span 1; }
}
</style>

<!-- external libs for PDF & canvas -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
// --- CONFIG: adjust if you want to call your Vercel API/Resend endpoint ---
const BACKEND_ENDPOINT = "/api/send-letter"; // change or remove if not needed

// Opening paragraphs by role (for key roles; others get generic)
const openingsByRole = {
  // Executive
  "Chief Executive Officer":
    "As Chief Executive Officer of our organisation, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Nurse":
    "In my capacity as Chief Nurse, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Medical Director":
    "In my role as Medical Director, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Director of Nursing":
    "As Director of Nursing, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Operating Officer (COO)":
    "In my capacity as Chief Operating Officer (COO), I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Digital & information
  "Chief Information Officer (CIO)":
    "As Chief Information Officer (CIO) for our organisation, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Nursing Information Officer (CNIO)":
    "In my capacity as Chief Nursing Information Officer (CNIO), I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Clinical Information Officer (CCIO)":
    "As Chief Clinical Information Officer (CCIO), I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Digital Information Officer (CDIO)":
    "In my role as Chief Digital Information Officer (CDIO), I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Divisional / senior management
  "Divisional Operations Director":
    "As Divisional Operations Director, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Divisional General Manager":
    "As Divisional General Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Divisional/Clinical Director":
    "In my capacity as Divisional/Clinical Director, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Divisional Nurse Director":
    "As Divisional Nurse Director, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Service management
  "General Manager":
    "As General Manager for the service, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Deputy General Manager":
    "As Deputy General Manager, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Service Manager":
    "As Service Manager for the department, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Associate Service Manager":
    "In my role as Associate Service Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Service Delivery Manager":
    "In my role as Service Delivery Manager for Theatres at the Royal London Hospital, Barts Health NHS Trust, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader within the department.",

  // Operational management
  "Head of Perioperative Services":
    "As Head of Perioperative Services at the Royal London Hospital, Barts Health NHS Trust, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres.",
  "Perioperative Services Manager":
    "In my role as Perioperative Services Manager, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Operations Manager":
    "As Operations Manager for perioperative services, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Deputy Operations Manager":
    "In my role as Deputy Operations Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Site Manager":
    "As Site Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Professional / nursing leadership
  "Associate Director of Nursing":
    "In my capacity as Associate Director of Nursing, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Head of Nursing":
    "As Head of Nursing, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Matron":
    "As Matron for the Theatre Department, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Deputy Matron":
    "In my role as Deputy Matron, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Practice Development Nurse":
    "In my role as Practice Development Nurse, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Senior Team Leader":
    "In my capacity as a Senior Team Leader in theatres, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Associate Team Leader":
    "As an Associate Team Leader within the perioperative service, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Medical staff
  "Consultant Anaesthetist":
    "I am pleased to provide a letter of support for Alex Monterubio, with whom I worked during theatre sessions at the Royal London Hospital, Barts Health NHS Trust, where Alex previously held the position of Senior Team Leader in Theatres.",
  "Consultant Surgeon":
    "As a Consultant Surgeon at the Royal London Hospital, Barts Health NHS Trust, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres.",
  "Senior Registrar":
    "I am pleased to provide a letter of support for Alex Monterubio, whom I had the opportunity to work with during surgical lists at the Royal London Hospital, Barts Health NHS Trust, where Alex previously worked as a Senior Team Leader in Theatres.",
  "Surgical Fellow":
    "As a Surgical Fellow working within the theatre environment, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Anaesthetic Fellow":
    "As an Anaesthetic Fellow, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Specialty Doctor / SAS Doctor":
    "As a Specialty (SAS) Doctor working regularly in theatres, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust."
};

// London hospitals directory - embedded data
let hospitalDirectory = [
  {"hospital":"The Royal London Hospital","trust":"Barts Health NHS Trust","address":"Whitechapel Road, Whitechapel, London","postcode":"E1 1FR"},
  {"hospital":"St Bartholomew's Hospital","trust":"Barts Health NHS Trust","address":"West Smithfield, London","postcode":"EC1A 7BE"},
  {"hospital":"Whipps Cross University Hospital","trust":"Barts Health NHS Trust","address":"Whipps Cross Road, Leytonstone, London","postcode":"E11 1NR"},
  {"hospital":"Newham University Hospital","trust":"Barts Health NHS Trust","address":"Glen Road, Plaistow, London","postcode":"E13 8SL"},
  {"hospital":"Guy's Hospital","trust":"Guy's and St Thomas' NHS Foundation Trust","address":"Great Maze Pond, London","postcode":"SE1 9RT"},
  {"hospital":"St Thomas' Hospital","trust":"Guy's and St Thomas' NHS Foundation Trust","address":"Westminster Bridge Road, London","postcode":"SE1 7EH"},
  {"hospital":"King's College Hospital","trust":"King's College Hospital NHS Foundation Trust","address":"Denmark Hill, London","postcode":"SE5 9RS"},
  {"hospital":"University College Hospital","trust":"University College London Hospitals NHS Foundation Trust","address":"235 Euston Road, London","postcode":"NW1 2BU"},
  {"hospital":"Hammersmith Hospital","trust":"Imperial College Healthcare NHS Trust","address":"Du Cane Road, London","postcode":"W12 0HS"},
  {"hospital":"St George's Hospital","trust":"St George's University Hospitals NHS Foundation Trust","address":"Blackshaw Road, Tooting, London","postcode":"SW17 0QT"},
  {"hospital":"University Hospital Lewisham","trust":"Lewisham and Greenwich NHS Trust","address":"Lewisham High Street, Lewisham, London","postcode":"SE13 6LH"},
  {"hospital":"Central Middlesex Hospital","trust":"London North West University Healthcare NHS Trust","address":"Acton Lane, Park Royal, London","postcode":"NW10 7NS"},
  {"hospital":"Chelsea & Westminster Hospital","trust":"Chelsea and Westminster Hospital NHS Foundation Trust","address":"369 Fulham Road, Chelsea, London","postcode":"SW10 9NH"},
  {"hospital":"West Middlesex University Hospital","trust":"Chelsea and Westminster Hospital NHS Foundation Trust","address":"Twickenham Road, Isleworth, London","postcode":"TW7 6AF"},
  {"hospital":"Hillingdon Hospital","trust":"The Hillingdon Hospitals NHS Foundation Trust","address":"Pield Heath Road, Hillingdon, Middlesex","postcode":"UB8 3NN"},
  {"hospital":"The Royal Marsden Hospital (Chelsea)","trust":"The Royal Marsden NHS Foundation Trust","address":"Fulham Road, London","postcode":"SW3 6JJ"},
  {"hospital":"Moorfields Eye Hospital","trust":"Moorfields Eye Hospital NHS Foundation Trust","address":"162 City Road, London","postcode":"EC1V 2PD"},
  {"hospital":"Queen's Hospital (Romford)","trust":"Barking, Havering & Redbridge University Hospitals NHS Trust","address":"Gaynes Parkway, Romford","postcode":"RM7 0AG"},
  {"hospital":"King George Hospital","trust":"Barking, Havering & Redbridge University Hospitals NHS Trust","address":"Barley Lane, Goodmayes, Ilford, London","postcode":"IG3 8YB"},
  {"hospital":"Mount Vernon Hospital","trust":"The Hillingdon Hospitals NHS Foundation Trust","address":"Rickmansworth Road, Northwood, Middlesex","postcode":"HA6 2RN"},
  {"hospital":"Barnet Hospital","trust":"Royal Free London NHS Foundation Trust","address":"Wellhouse Lane, Barnet, London","postcode":"EN5 3DJ"},
  {"hospital":"Chase Farm Hospital","trust":"Royal Free London NHS Foundation Trust","address":"The Ridgeway, Enfield, Middlesex","postcode":"EN2 8JL"}
];

function parseAddress(addressStr){
  // Parse "Street, Area, City" format into components
  const parts = addressStr.split(',').map(s => s.trim());
  if (parts.length === 1){
    return { line1: parts[0], line2: "", city: "" };
  } else if (parts.length === 2){
    return { line1: parts[0], line2: "", city: parts[1] };
  } else {
    // 3+ parts: first is line1, second is line2, last is city
    return {
      line1: parts[0],
      line2: parts.slice(1, -1).join(', '),
      city: parts[parts.length - 1]
    };
  }
}

// Normalize text for fuzzy matching
function normalizeText(text){
  return text
    .toLowerCase()
    .replace(/['']/g, "'") // Normalize apostrophes
    .replace(/\s+/g, ' ')   // Normalize spaces
    .trim();
}

// Fuzzy match scoring
function fuzzyScore(search, target){
  const searchNorm = normalizeText(search);
  const targetNorm = normalizeText(target);

  // Exact match
  if (searchNorm === targetNorm) return 100;

  // Contains exact search
  if (targetNorm.includes(searchNorm)) return 80;

  // Search contains target (user typed more)
  if (searchNorm.includes(targetNorm)) return 70;

  // All search words present in target
  const searchWords = searchNorm.split(' ').filter(w => w.length > 2);
  const targetWords = targetNorm.split(' ');

  const matchedWords = searchWords.filter(sw =>
    targetWords.some(tw => tw.includes(sw) || sw.includes(tw))
  );

  if (matchedWords.length === searchWords.length && searchWords.length > 0){
    return 60;
  }

  // Partial word matches
  if (matchedWords.length > 0){
    return 40 * (matchedWords.length / searchWords.length);
  }

  return 0;
}

function findHospitalMatch(name){
  if (!name || !hospitalDirectory.length) return null;

  const matches = hospitalDirectory.map(h => ({
    hospital: h,
    score: fuzzyScore(name, h.hospital)
  })).filter(m => m.score > 30);

  matches.sort((a, b) => b.score - a.score);

  return matches.length > 0 ? matches[0].hospital : null;
}

function findTrustMatch(orgName){
  if (!orgName || !hospitalDirectory.length) return null;

  const matches = hospitalDirectory.map(h => ({
    hospital: h,
    score: fuzzyScore(orgName, h.trust)
  })).filter(m => m.score > 30);

  matches.sort((a, b) => b.score - a.score);

  return matches.length > 0 ? matches[0].hospital : null;
}

// trust splitter
function splitTrust(orgValue){
  if (!orgValue) return { main:"", sub:"" };
  const v = orgValue.trim();
  const idx = v.indexOf(" NHS");
  if (idx === -1){
    return { main: v, sub: "" };
  }
  return {
    main: v.slice(0, idx).trim(),
    sub:  v.slice(idx + 1).trim()
  };
}

// date helpers
function todayUK(){
  const opts = { day: 'numeric', month: 'long', year: 'numeric' };
  return new Date().toLocaleDateString('en-GB', opts);
}
function todayUKISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function toUKLong(dateISO){
  try{
    const d = new Date(dateISO);
    if (isNaN(d)) return todayUK();
    return d.toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });
  }catch(e){ return todayUK(); }
}

let sigPad; // custom wrapper
let currentStep = 1;
const totalSteps = 4;

function readForm(){
  const motivationSelected = Array.from(
    document.querySelectorAll('input[name="motivation"]:checked')
  ).map(el => el.value);

  const professionalStrengthsSelected = Array.from(
    document.querySelectorAll('input[name="professional_strengths"]:checked')
  ).map(el => el.value);

  const clinicalImpactSelected = Array.from(
    document.querySelectorAll('input[name="clinical_impact"]:checked')
  ).map(el => el.value);

  const nhsPrioritiesSelected = Array.from(
    document.querySelectorAll('input[name="nhs_priorities"]:checked')
  ).map(el => el.value);

  const innovationViabilitySelected = Array.from(
    document.querySelectorAll('input[name="innovation_viability"]:checked')
  ).map(el => el.value);

  return {
    refName: document.getElementById('ref_name').value.trim(),
    refRole: document.getElementById('ref_role').value,
    refRoleOther: (document.getElementById('ref_role_other')?.value || "").trim(),
    org: document.getElementById('org').value.trim(),
    email: document.getElementById('ref_email').value.trim(),
    phone: document.getElementById('ref_phone').value.trim(),

    professionalArea: (document.getElementById('professional_area')?.value || ""),
    relationship: (document.getElementById('relationship')?.value || ""),
    otherRelationshipCapacity: (document.getElementById('other_relationship_capacity')?.value || "").trim(),
    customLetterText: (document.getElementById('custom_letter_text')?.value || "").trim(),

    hospitalName: (document.getElementById('hospital_name')?.value || "").trim(),
    hospitalAddr1: (document.getElementById('hospital_addr1')?.value || "").trim(),
    hospitalAddr2: (document.getElementById('hospital_addr2')?.value || "").trim(),
    hospitalCity: (document.getElementById('hospital_city')?.value || "").trim(),
    hospitalPostcode: (document.getElementById('hospital_postcode')?.value || "").trim(),

    useHeader: true, // Always include NHS header
    dateLine: (document.getElementById('date_line')?.value || "").trim(),

    qDurationSelect: (document.getElementById('q_duration_select')?.value || ""),
    qDurationDetail: (document.getElementById('q_duration_detail')?.value || "").trim(),

    motivationSelected,
    professionalStrengthsSelected,
    clinicalImpactSelected,
    nhsPrioritiesSelected,
    innovationViabilitySelected
  };
}

/* Step validation – only for the visible step */
function validateStep(stepNumber){
  const stepEl = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
  if (!stepEl) return true;

  const fields = stepEl.querySelectorAll('input, select, textarea');
  fields.forEach(el => { el.style.borderColor = '#d1d5db'; });

  let valid = true;
  let firstProblem = null;

  const required = stepEl.querySelectorAll('[required]');
  required.forEach(el => {
    if (!el.checkValidity()) {
      valid = false;
      el.style.borderColor = '#dc2626';
      if (!firstProblem) firstProblem = el;
    }
  });

  if (!valid && firstProblem){
    if (firstProblem.scrollIntoView){
      firstProblem.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    if (firstProblem.focus){
      firstProblem.focus();
    }
  }

  return valid;
}

/* Full-form validation (for final submit) */
function validateForm(){
  const form = document.getElementById('endorsement-form');
  if (!form) return true;

  const fields = form.querySelectorAll('input, select, textarea');
  fields.forEach(el => { el.style.borderColor = '#d1d5db'; });
  const strengthsGroup = document.getElementById('strengths_group');
  if (strengthsGroup){
    strengthsGroup.style.border = 'none';
    strengthsGroup.style.padding = '0';
  }

  let formValid = true;
  let firstInvalidElement = null;

  const required = form.querySelectorAll('[required]');
  required.forEach(el => {
    if (!el.checkValidity()){
      formValid = false;
      el.style.borderColor = '#dc2626';
      if (!firstInvalidElement) firstInvalidElement = el;
    }
  });

  const strengthsChecked = form.querySelectorAll('input[name="strengths"]:checked').length;
  const strengthsOtherVal = (document.getElementById('q_strengths_other')?.value || "").trim();
  const strengthsValid = strengthsChecked > 0 || strengthsOtherVal.length > 0;
  if (!strengthsValid){
    formValid = false;
    if (strengthsGroup){
      strengthsGroup.style.border = '1px solid #dc2626';
      strengthsGroup.style.borderRadius = '6px';
      strengthsGroup.style.padding = '8px';
    }
    if (!firstInvalidElement && strengthsGroup){
      firstInvalidElement = strengthsGroup;
    }
  }

  // require a drawn signature
  if (sigPad && sigPad.isEmpty()){
    formValid = false;
    alert("Please provide your signature before submitting.");
    const stepEl = document.querySelector('.form-step[data-step="4"]');
    if (stepEl){
      showStep(4);
      stepEl.scrollIntoView({ behavior:'smooth', block:'start' });
    }
  }

  if (!formValid && firstInvalidElement){
    const stepEl = firstInvalidElement.closest('.form-step');
    if (stepEl && stepEl.dataset.step){
      showStep(parseInt(stepEl.dataset.step, 10));
    }
    if (firstInvalidElement.scrollIntoView){
      firstInvalidElement.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    if (firstInvalidElement.focus){
      firstInvalidElement.focus();
    }
    return false;
  }

  return true;
}

/* Skeleton letter: up to Re: line only */
function buildSkeletonLetterHTML(data){
  const {
    refName,
    refRole,
    refRoleOther,
    org,
    email,
    phone,
    dateLine,
    hospitalName,
    hospitalAddr1,
    hospitalAddr2,
    hospitalCity,
    hospitalPostcode,
    useHeader
  } = data;

  const effectiveRole = (refRole === "Other" && refRoleOther) ? refRoleOther : refRole;

  const dateStr = dateLine ? toUKLong(dateLine) : todayUK();
  const hospital = hospitalName || "";
  const { main: trustMain, sub: trustSub } = splitTrust(org || "");

  const addressHTML = (hospitalAddr1 || hospitalAddr2 || hospitalCity || hospitalPostcode)
    ? `
      <div class="trust-address">
        ${hospitalAddr1 ? hospitalAddr1 + "<br/>" : ""}
        ${hospitalAddr2 ? hospitalAddr2 + "<br/>" : ""}
        ${
          (hospitalCity || hospitalPostcode)
            ? `${hospitalCity || ""}${hospitalCity && hospitalPostcode ? ", " : ""}${hospitalPostcode || ""}`
            : ""
        }
      </div>
    `
    : "";

  const headerHTML = useHeader ? `
    <div class="header-block">
      <div class="trust-header">
        <img src="nhs-logo.png" alt="NHS logo" class="nhs-logo-img"/>
        ${trustMain ? `<div class="trust-name">${trustMain}</div>` : ""}
        ${trustSub  ? `<div class="trust-sub">${trustSub}</div>` : ""}
        ${hospital ? `<div class="trust-hospital">${hospital}</div>` : ""}
        ${addressHTML}
      </div>
    </div>
  ` : "";

  const senderHTML = `
    <div class="sender-block">
      <div>${refName || "[Referee Name]"}</div>
      <div>${effectiveRole || "[Role]"}</div>
      ${phone ? `<div>Tel: ${phone}</div>` : ""}
      ${email ? `<div>Email: ${email}</div>` : ""}
    </div>
  `;

  const recipientHTML = `
    <div class="recipient-block">
      <div>NHS Clinical Entrepreneur Team</div>
      <div>c/o Anglia Ruskin University</div>
      <div>Bishop Hall Lane</div>
      <div>Chelmsford</div>
      <div>Essex</div>
      <div>CM1 1SQ</div>
    </div>
    <div class="recipient-subject">
      Re: Letter of Support for Alex Monterubio – NHS Clinical Entrepreneur Programme Application
    </div>
  `;

  return `
    <div class="paper" id="paper">
      <div class="page">
        <div class="header-row">
          ${senderHTML}
          ${headerHTML}
        </div>
        <div class="letter-date">Date: ${dateStr}</div>
        ${recipientHTML}
        <div style="font-family: Arial, sans-serif; font-size: 10pt; color:#9ca3af; margin-top:16px;">
          The body of your letter will appear here once you start answering the endorsement questions.
        </div>
      </div>
    </div>
  `;
}

function buildLetterHTML(data, signatureDataURL){
  const {
    refName,
    refRole,
    refRoleOther,
    org,
    email,
    phone,
    professionalArea,
    relationship,
    otherRelationshipCapacity,
    customLetterText,
    dateLine,
    hospitalName,
    hospitalAddr1,
    hospitalAddr2,
    hospitalCity,
    hospitalPostcode,
    useHeader,
    qDurationSelect,
    qDurationDetail,
    motivationSelected,
    professionalStrengthsSelected,
    clinicalImpactSelected,
    nhsPrioritiesSelected,
    innovationViabilitySelected
  } = data;

  const effectiveRole = (refRole === "Other" && refRoleOther) ? refRoleOther : refRole;

  const opening = openingsByRole[effectiveRole] ||
    "I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.";

  const dateStr = dateLine ? toUKLong(dateLine) : todayUK();

  const hospital = hospitalName || "";
  const { main: trustMain, sub: trustSub } = splitTrust(org || "");

  const addressHTML = (hospitalAddr1 || hospitalAddr2 || hospitalCity || hospitalPostcode)
    ? `
      <div class="trust-address">
        ${hospitalAddr1 ? hospitalAddr1 + "<br/>" : ""}
        ${hospitalAddr2 ? hospitalAddr2 + "<br/>" : ""}
        ${
          (hospitalCity || hospitalPostcode)
            ? `${hospitalCity || ""}${hospitalCity && hospitalPostcode ? ", " : ""}${hospitalPostcode || ""}`
            : ""
        }
      </div>
    `
    : "";

  const headerHTML = useHeader ? `
    <div class="header-block">
      <div class="trust-header">
        <img src="nhs-logo.png" alt="NHS logo" class="nhs-logo-img"/>
        ${trustMain ? `<div class="trust-name">${trustMain}</div>` : ""}
        ${trustSub  ? `<div class="trust-sub">${trustSub}</div>` : ""}
        ${hospital ? `<div class="trust-hospital">${hospital}</div>` : ""}
        ${addressHTML}
      </div>
    </div>
  ` : "";

  const senderHTML = `
    <div class="sender-block">
      <div>${refName || "[Referee Name]"}</div>
      <div>${effectiveRole || "[Role]"}</div>
      ${phone ? `<div>Tel: ${phone}</div>` : ""}
      ${email ? `<div>Email: ${email}</div>` : ""}
    </div>
  `;

  const recipientHTML = `
    <div class="recipient-block">
      <div>NHS Clinical Entrepreneur Team</div>
      <div>c/o Anglia Ruskin University</div>
      <div>Bishop Hall Lane</div>
      <div>Chelmsford</div>
      <div>Essex</div>
      <div>CM1 1SQ</div>
    </div>
    <div class="recipient-subject">
      Re: Letter of Support for Alex Monterubio – NHS Clinical Entrepreneur Programme Application
    </div>
  `;

  const salutationHTML = `<p class="sal">Dear NHS Clinical Entrepreneur Team,</p>`;

  // If different professional area, show placeholder for custom message
  console.log('buildLetterHTML - professionalArea:', professionalArea, 'customLetterText length:', customLetterText?.length || 0);
  if (professionalArea === 'different'){
    console.log('Using Other Professional Relationship - custom message placeholder');

    const sigHTML = signatureDataURL
      ? `<div class="letter-sign"><img src="${signatureDataURL}" alt="Signature"/></div>`
      : "";

    // Show placeholder for custom message entry
    const customMessageHTML = customLetterText
      ? customLetterText.split('\n\n').map(p => p.trim() ? `<p>${p.trim()}</p>` : '').join('')
      : `<p style="color:#9ca3af; font-style:italic;">Your custom message will appear here once you complete Step 3 (Custom Letter).</p>`;

    return `
      <div class="paper" id="paper">
        <div class="page">
          <div class="header-row">
            ${senderHTML}
            ${headerHTML}
          </div>
          <div class="letter-date">Date: ${dateStr}</div>
          ${recipientHTML}
          <div class="letter-body">
            ${salutationHTML}
            ${customMessageHTML}
            <div class="letter-closing">
              <p>Yours faithfully,</p>
              ${sigHTML}
              <div class="letter-signoff">
                <div class="name">${refName || "[Name]"}</div>
                <div>${effectiveRole || "[Role]"}</div>
                <div>${org || "Barts Health NHS Trust"}</div>
                <div>${email ? `Contact: ${email}` : ""}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Otherwise, use perioperative template
  console.log('Using perioperative template');
  const narrativeParts = [];

  // Duration phrase
  let durationPhrase = "";
  if (qDurationSelect){
    if (qDurationSelect === "other" && qDurationDetail){
      durationPhrase = qDurationDetail;
    } else {
      switch (qDurationSelect){
        case "less than six months":
          durationPhrase = ""; // handled with "Although..."
          break;
        case "between six and twelve months":
          durationPhrase = "the past six to twelve months";
          break;
        case "between one and three years":
          durationPhrase = "the past one to three years";
          break;
        case "more than three years":
          durationPhrase = "a period of more than three years";
          break;
        default:
          durationPhrase = qDurationSelect;
      }
      if (qDurationDetail && qDurationSelect !== "less than six months"){
        durationPhrase += ` (${qDurationDetail})`;
      }
    }
  }

  // Capacity/Relationship
  // For Perioperative: use 'relationship' dropdown
  // For Other: use 'otherRelationshipCapacity' free text
  let capacityText = "";
  if (professionalArea === 'perioperative' && relationship){
    capacityText = relationship;
  } else if (professionalArea === 'different' && otherRelationshipCapacity){
    capacityText = otherRelationshipCapacity;
  }

  // Relationship sentence
  let relationshipSentence = "";
  if (qDurationSelect || capacityText){
    if (qDurationSelect === "less than six months") {
      relationshipSentence = "Although my time working with Alex has been relatively short";
    } else {
      relationshipSentence = "Over ";
      relationshipSentence += durationPhrase ? durationPhrase : "the time that Alex worked within our service";
    }

    relationshipSentence += ", I have known Alex";

    if (capacityText){
      relationshipSentence += ` in my capacity as ${capacityText.toLowerCase()}`;
    }

    relationshipSentence += ", and have been able to observe their practice in a busy perioperative environment.";
  }

  let intro = opening;
  if (relationshipSentence){
    intro += " " + relationshipSentence;
  }
  narrativeParts.push(`<p>${intro}</p>`);

  // Helper function to format array into narrative sentence
  const formatList = (items) => {
    if (!items || items.length === 0) return "";
    if (items.length === 1) return items[0];
    if (items.length === 2) return items.join(" and ");
    return items.slice(0, -1).join(", ") + ", and " + items[items.length - 1];
  };

  // 1. Motivation
  if (motivationSelected && motivationSelected.length > 0){
    const motivationPhrase = formatList(motivationSelected);
    narrativeParts.push(`<p>In my assessment, Alex ${motivationPhrase}.</p>`);
  }

  // 2. Professional strengths
  if (professionalStrengthsSelected && professionalStrengthsSelected.length > 0){
    const strengthsPhrase = formatList(professionalStrengthsSelected);
    narrativeParts.push(`<p>From a professional capability perspective, Alex ${strengthsPhrase}.</p>`);
  }

  // 3. Clinical impact
  if (clinicalImpactSelected && clinicalImpactSelected.length > 0){
    const impactPhrase = formatList(clinicalImpactSelected);
    narrativeParts.push(`<p>Regarding their potential for creating meaningful clinical impact, I observe that Alex ${impactPhrase}.</p>`);
  }

  // 4. NHS priorities
  if (nhsPrioritiesSelected && nhsPrioritiesSelected.length > 0){
    const prioritiesPhrase = formatList(nhsPrioritiesSelected);
    narrativeParts.push(`<p>Alex's proposed innovation ${prioritiesPhrase}.</p>`);
  }

  // 5. Innovation viability
  if (innovationViabilitySelected && innovationViabilitySelected.length > 0){
    const viabilityPhrase = formatList(innovationViabilitySelected);
    narrativeParts.push(`<p>In terms of viability, ${viabilityPhrase}.</p>`);
  }

  // Final paragraph: MBA + suitability
  const mbaSentence = "Alex is currently undertaking an Executive MBA, further developing their leadership, strategic and innovation skills, qualities that align closely with the objectives of the NHS Clinical Entrepreneur Programme.";
  const suitabilitySentence = "On the basis of the above, and my experience of working with Alex, I consider them well suited to the NHS Clinical Entrepreneur Programme and capable of contributing positively to innovation within the NHS.";
  narrativeParts.push(`<p>${mbaSentence} ${suitabilitySentence}</p>`);

  narrativeParts.push(
    `<p>This letter is provided as a professional endorsement of Alex Monterubio’s suitability for the NHS Clinical Entrepreneur Programme. It does not imply financial sponsorship.</p>`
  );

  const sigHTML = signatureDataURL
    ? `<div class="letter-sign"><img src="${signatureDataURL}" alt="Signature"/></div>`
    : "";

  const bodyHTML = narrativeParts.join("");

  return `
    <div class="paper" id="paper">
      <div class="page">
        <div class="header-row">
          ${senderHTML}
          ${headerHTML}
        </div>
        <div class="letter-date">Date: ${dateStr}</div>
        ${recipientHTML}
        <div class="letter-body">
          ${salutationHTML}
          ${bodyHTML}
          <div class="letter-closing">
            <p>Yours faithfully,</p>
            ${sigHTML}
            <div class="letter-signoff">
              <div class="name">${refName || "[Name]"}</div>
              <div>${effectiveRole || "[Role]"}</div>
              <div>${org || "Barts Health NHS Trust"}</div>
              <div>${email ? `Contact: ${email}` : ""}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function updatePreview(){
  const data = readForm();
  const preview = document.getElementById('preview');

  const hasRefDetails =
    data.refName ||
    data.refRole ||
    data.refRoleOther ||
    data.org ||
    data.email ||
    data.phone ||
    data.hospitalName ||
    data.hospitalAddr1 ||
    data.hospitalAddr2 ||
    data.hospitalCity ||
    data.hospitalPostcode ||
    data.useHeader;

  const hasQuestionContent =
    data.customLetterText ||
    data.qDurationSelect ||
    data.qDurationDetail ||
    data.qCapacitySelect ||
    data.qCapacityOther ||
    data.qCapacityDetail ||
    data.strengthsSelected.length ||
    data.qStrengthsOther ||
    data.qProfessionalism ||
    data.qTeamwork ||
    data.qSuitabilitySelect ||
    data.qSuitabilityDetail;

  const hasSignature = sigPad && !sigPad.isEmpty();

  // 1) Nothing at all -> placeholder
  if (!hasRefDetails && !hasQuestionContent && !hasSignature){
    preview.innerHTML = `
      <div style="font-family: Arial, sans-serif; font-size: 11pt; color:#6b7280; text-align:center; padding:40px 20px;">
        Your letter preview will appear here once you have completed the questions.
      </div>
    `;
    return;
  }

  // 2) Only ref details but no questions/signature -> skeleton letter up to Re: line
  if (hasRefDetails && !hasQuestionContent && !hasSignature){
    preview.innerHTML = buildSkeletonLetterHTML(data);
    return;
  }

  // 3) Once any questions answered or signature added -> full letter
  const sigDataURL = hasSignature ? sigPad.toDataURL() : "";
  const html = buildLetterHTML(data, sigDataURL);
  preview.innerHTML = html;
}

function formRef(){
  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  return `NHSCEP–${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

async function makePDF(){
  const previewPaper = document.querySelector('#preview #paper');
  if (!previewPaper){ throw new Error("Preview not ready"); }

  // Temporarily remove zoom for proper A4 capture
  const originalZoom = previewPaper.style.zoom;
  previewPaper.style.zoom = '1';

  const ref = formRef();
  const footer = document.createElement('div');
  footer.style.fontFamily = 'Arial, sans-serif';
  footer.style.fontSize = '8pt';
  footer.style.color = '#6b7280';
  footer.style.marginTop = '16px';
  footer.style.paddingTop = '8px';
  footer.style.borderTop = '1px solid #e5e7eb';
  footer.innerHTML = `
    <div style="margin-bottom:4px;"><strong>Reference:</strong> ${ref}</div>
    <div>
      This letter was generated through the NHS Clinical Entrepreneur Programme Digital Endorsement Form developed by Alex Monterubio.
      Submitted electronically via https://www.nhscep.com.
      <strong>No patient or confidential data is stored by this tool – it is a one-off letter generator.</strong>
    </div>
  `;
  previewPaper.appendChild(footer);

  // Capture at proper A4 dimensions (210mm x 297mm = 794px x 1123px at 96 DPI)
  const canvas = await html2canvas(previewPaper, {
    scale: 2,
    useCORS: false,
    backgroundColor: '#ffffff',
    windowWidth: 794,
    windowHeight: 1123
  });
  footer.remove();

  // Restore zoom
  previewPaper.style.zoom = originalZoom;

  const imgData = canvas.toDataURL('image/png', 1.0);
  const pdf = new jspdf.jsPDF('p', 'mm', 'a4');

  // A4 dimensions in mm
  const pageWidth = 210;
  const pageHeight = 297;

  // Add image to fit A4 perfectly with proper margins
  pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);

  const blob = pdf.output('blob');
  const dataURI = pdf.output('datauristring');
  const filename = `Letter_of_Support_${(document.getElementById('ref_role').value || 'Referee').replace(/\s+/g,'_')}_Alex_Monterubio.pdf`;
  return { pdfBlob: blob, pdfDataURI: dataURI, filename, ref };
}

// Call your Vercel/Resend API (optional)
async function sendToBackend(payload){
  if (!BACKEND_ENDPOINT) return;
  try{
    await fetch(BACKEND_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (e){
    console.error("Backend send failed:", e);
  }
}

function showToast(){
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 7000);
}

async function handleSubmit(){
  if (!validateForm()) { return; }

  // Make sure preview (with signature) is up to date
  updatePreview();

  const data = readForm();
  const { pdfBlob, pdfDataURI, filename, ref } = await makePDF();

  // Trigger download
  const a = document.createElement('a');
  a.href = URL.createObjectURL(pdfBlob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();

  const effectiveRole = (data.refRole === "Other" && data.refRoleOther) ? data.refRoleOther : data.refRole;

  // Optional: send to backend (e.g. Resend on Vercel)
  if (data.email){
    await sendToBackend({
      refCode: ref,
      filename,
      pdfBase64: pdfDataURI.split(',')[1],
      referee: {
        name: data.refName,
        role: effectiveRole,
        email: data.email,
        phone: data.phone
      }
    });
  }

  document.getElementById('endorsement-form').reset();
  if (sigPad){ sigPad.clear(); }
  const dateInput = document.getElementById('date_line');
  dateInput.type = 'date';
  dateInput.value = todayUKISO();
  updatePreview();
  showToast();
}

function printLetter(){
  window.print();
}

function handleCapacityChange(){
  const select = document.getElementById('q_capacity_select');
  const otherWrap = document.getElementById('capacity_other_wrap');
  if (!select || !otherWrap) return;
  if (select.value === 'other'){
    otherWrap.classList.remove('hidden');
  } else {
    otherWrap.classList.add('hidden');
    const otherInput = document.getElementById('q_capacity_other');
    if (otherInput) otherInput.value = "";
  }
}

/* Stepper helpers */
function showStep(step){
  currentStep = step;

  const stepNames = ['Your details', 'Relationship', 'Strengths', 'Sign & submit'];

  // Handle special step "2a" for custom letter
  if (step === '2a' || step === 2.5){
    document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
    const customStep = document.getElementById('step-custom-letter');
    if (customStep) customStep.classList.add('active');

    const progress = document.querySelector('.progress-bar');
    if (progress) progress.style.width = '25%';

    const labelSpan = document.getElementById('step-counter');
    if (labelSpan) labelSpan.textContent = 'Step 2 of 3';

    // Update step labels - show previous and current
    const labelsContainer = document.getElementById('step-labels-container');
    if (labelsContainer){
      labelsContainer.innerHTML = `
        <span>Your details</span>
        <span class="is-active">Custom letter</span>
      `;
    }

    const leftPanel = document.querySelector('.panel.left');
    if (leftPanel && leftPanel.scrollTo){
      leftPanel.scrollTo({ top:0, behavior:'smooth' });
    }
    return;
  }

  document.querySelectorAll('.form-step').forEach(s => {
    // Exact match to avoid "2a" matching when step is 2
    const isMatch = String(s.dataset.step) === String(step);
    s.classList.toggle('active', isMatch);
  });

  // Explicitly ensure Step 2A (custom letter) is hidden when on Step 2
  const customLetterStep = document.getElementById('step-custom-letter');
  if (step === 2 && customLetterStep){
    customLetterStep.classList.remove('active');
    customLetterStep.classList.add('hidden');
  }
  if (step === '2a' && customLetterStep){
    customLetterStep.classList.remove('hidden');
  }

  const progress = document.querySelector('.progress-bar');
  if (progress){
    const pct = ((step - 1) / (totalSteps - 1)) * 100;
    progress.style.width = `${pct}%`;
  }

  const labelSpan = document.getElementById('step-counter');
  if (labelSpan){
    labelSpan.textContent = `Step ${step} of ${totalSteps}`;
  }

  // Update step labels - show only previous and current
  const labelsContainer = document.getElementById('step-labels-container');
  if (labelsContainer){
    let html = '';

    // Show previous step if not on step 1
    if (step > 1){
      html += `<span>${stepNames[step - 2]}</span>`;
    }

    // Show current step
    html += `<span class="is-active">${stepNames[step - 1]}</span>`;

    labelsContainer.innerHTML = html;
  }

  const leftPanel = document.querySelector('.panel.left');
  if (leftPanel && leftPanel.scrollTo){
    leftPanel.scrollTo({ top:0, behavior:'smooth' });
  }

  // when going to step 4, ensure the signature canvas is sized
  if (step === 4) {
    const event = new Event('resize');
    window.dispatchEvent(event);
  }
}

function goToFinalStep(){
  // For different professional area, go directly to step 4 (signature)
  const customText = document.getElementById('custom_letter_text');
  if (customText && !customText.value.trim()){
    customText.style.borderColor = '#dc2626';
    alert('Please write your letter of support before continuing.');
    return;
  }
  showStep(4);
}

function handleProfessionalAreaChange(){
  const areaSelect = document.getElementById('professional_area');
  const perioperativeCapacityWrap = document.getElementById('perioperative_capacity_wrap');
  const otherCapacityWrap = document.getElementById('other_capacity_wrap');
  const relationshipSelect = document.getElementById('relationship');
  const otherRelationshipInput = document.getElementById('other_relationship_capacity');
  const durationLabel = document.getElementById('duration_label');

  if (!areaSelect) return;

  const area = areaSelect.value;

  if (area === 'different'){
    // Show free text capacity for Other Professional Relationship
    if (perioperativeCapacityWrap) perioperativeCapacityWrap.classList.add('hidden');
    if (otherCapacityWrap) otherCapacityWrap.classList.remove('hidden');
    if (relationshipSelect) relationshipSelect.removeAttribute('required');
    if (otherRelationshipInput) otherRelationshipInput.setAttribute('required', 'required');
    if (durationLabel) durationLabel.textContent = 'How long have you known or worked with Alex?';
  } else if (area === 'perioperative'){
    // Show dropdown capacity for Perioperative/Theatre Colleague
    if (perioperativeCapacityWrap) perioperativeCapacityWrap.classList.remove('hidden');
    if (otherCapacityWrap) otherCapacityWrap.classList.add('hidden');
    if (relationshipSelect) relationshipSelect.setAttribute('required', 'required');
    if (otherRelationshipInput) otherRelationshipInput.removeAttribute('required');
    if (durationLabel) durationLabel.textContent = 'How long have you worked with Alex?';
  } else {
    // Nothing selected - hide both
    if (perioperativeCapacityWrap) perioperativeCapacityWrap.classList.add('hidden');
    if (otherCapacityWrap) otherCapacityWrap.classList.add('hidden');
    if (relationshipSelect) relationshipSelect.removeAttribute('required');
    if (otherRelationshipInput) otherRelationshipInput.removeAttribute('required');
  }

  updatePreview();
}

function toggleOptionalField(wrapId){
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  if (wrap.classList.contains('hidden')){
    wrap.classList.remove('hidden');
  } else {
    wrap.classList.add('hidden');
    // Clear the textarea when hiding
    const textarea = wrap.querySelector('textarea');
    if (textarea) textarea.value = '';
  }
  updatePreview();
}

function toggleDurationDetail(){
  const select = document.getElementById('q_duration_select');
  const detailWrap = document.getElementById('duration_detail_wrap');
  if (!select || !detailWrap) return;

  if (select.value === 'other'){
    detailWrap.classList.remove('hidden');
  } else {
    detailWrap.classList.add('hidden');
    const detailInput = document.getElementById('q_duration_detail');
    if (detailInput) detailInput.value = '';
  }
  updatePreview();
}

window.addEventListener('DOMContentLoaded', () => {
  // --- Signature: plain canvas drawing (no external library) ---
  const canvas = document.getElementById('signature-canvas');
  const ctx = canvas.getContext('2d');

  function resizeSignatureCanvas(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvas.getBoundingClientRect();
    if (!rect.width || !rect.height) return; // don't resize if hidden
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000000';
  }

  sigPad = {
    _empty: true,
    clear(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      this._empty = true;
    },
    isEmpty(){
      return this._empty;
    },
    toDataURL(){
      return canvas.toDataURL('image/png');
    }
  };

  let drawing = false;
  let lastX = 0;
  let lastY = 0;

  function getPos(evt){
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  }

  function startDraw(evt){
    evt.preventDefault();
    resizeSignatureCanvas(); // ensure size when first used
    const pos = getPos(evt);
    drawing = true;
    lastX = pos.x;
    lastY = pos.y;
    sigPad._empty = false;
    // Hide "Sign here" watermark
    const watermark = document.getElementById('sig-watermark');
    if (watermark) watermark.style.display = 'none';
  }

  function draw(evt){
    if (!drawing) return;
    evt.preventDefault();
    const pos = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }

  function endDraw(evt){
    if (!drawing) return;
    evt.preventDefault();
    drawing = false;
    updatePreview();
  }

  // Pointer/mouse
  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseleave', endDraw);

  // Touch
  canvas.addEventListener('touchstart', startDraw, { passive:false });
  canvas.addEventListener('touchmove', draw, { passive:false });
  canvas.addEventListener('touchend', endDraw, { passive:false });
  canvas.addEventListener('touchcancel', endDraw, { passive:false });

  const clearBtn = document.getElementById('clear-signature-btn');
  if (clearBtn){
    clearBtn.addEventListener('click', () => {
      sigPad.clear();
      updatePreview();
    });
  }

  // Date default
  const dateInput = document.getElementById('date_line');
  if (dateInput){
    dateInput.type = 'date';
    if (!dateInput.value){ dateInput.value = todayUKISO(); }
  }

  document.getElementById('endorsement-form').addEventListener('input', () => {
    updatePreview();
  });

  const capacitySelect = document.getElementById('q_capacity_select');
  if (capacitySelect){
    capacitySelect.addEventListener('change', () => {
      handleCapacityChange();
      updatePreview();
    });
  }

  // Role "Other" toggle
  const refRoleSelect = document.getElementById('ref_role');
  const refRoleOtherWrap = document.getElementById('ref_role_other_wrap');
  if (refRoleSelect && refRoleOtherWrap){
    const onRoleChange = () => {
      if (refRoleSelect.value === "Other"){
        refRoleOtherWrap.classList.remove('hidden');
      } else {
        refRoleOtherWrap.classList.add('hidden');
        const input = document.getElementById('ref_role_other');
        if (input) input.value = "";
      }
      updatePreview();
    };
    refRoleSelect.addEventListener('change', onRoleChange);
    onRoleChange();
  }

  // Step navigation buttons
  document.querySelectorAll('[data-next-step]').forEach(btn => {
    btn.addEventListener('click', () => {
      const step = parseInt(btn.dataset.nextStep,10);
      const current = step - 1;
      if (!validateStep(current)) return;

      showStep(step);
    });
  });
  document.querySelectorAll('[data-prev-step]').forEach(btn => {
    btn.addEventListener('click', () => {
      const step = parseInt(btn.dataset.prevStep,10);
      showStep(step);
    });
  });

  // Professional area change handler
  const professionalAreaSelect = document.getElementById('professional_area');
  if (professionalAreaSelect){
    professionalAreaSelect.addEventListener('change', handleProfessionalAreaChange);
    handleProfessionalAreaChange(); // Initialize on load
  }

  showStep(1);
  updatePreview();

  // Populate trust datalist with unique trusts
  const trustDatalist = document.getElementById('trust-list');
  if (trustDatalist){
    const uniqueTrusts = [...new Set(hospitalDirectory.map(h => h.trust))].sort();
    uniqueTrusts.forEach(trust => {
      const option = document.createElement('option');
      option.value = trust;
      trustDatalist.appendChild(option);
    });
  }

  // Populate hospital datalist
  const hospitalDatalist = document.getElementById('hospital-list');
  function updateHospitalList(filterTrust = null){
    if (!hospitalDatalist) return;
    hospitalDatalist.innerHTML = '';

    let hospitals = hospitalDirectory;
    if (filterTrust){
      hospitals = hospitals.filter(h => h.trust === filterTrust);
    }

    hospitals.forEach(h => {
      const option = document.createElement('option');
      option.value = h.hospital;
      option.setAttribute('data-trust', h.trust);
      hospitalDatalist.appendChild(option);
    });
  }

  // Initial population with all hospitals
  updateHospitalList();

  // Hospital name autocomplete
  const hospitalInput = document.getElementById('hospital_name');
  if (hospitalInput){
    const handleHospitalLookup = () => {
      const name = hospitalInput.value.trim();
      if (!name || name.length < 3) return;

      const match = findHospitalMatch(name);
      if (!match){
        updatePreview();
        return;
      }

      // Fill in hospital name (corrected)
      hospitalInput.value = match.hospital;

      // Fill in trust (always, since hospital determines trust)
      const orgInput = document.getElementById('org');
      if (orgInput){
        orgInput.value = match.trust;
        // Update hospital list to show hospitals in this trust
        updateHospitalList(match.trust);
        // Update hospital label
        const hospitalLabel = document.querySelector('label[for="hospital_name"]');
        if (hospitalLabel){
          const filteredCount = hospitalDirectory.filter(h => h.trust === match.trust).length;
          hospitalLabel.innerHTML = `Hospital name <span style="color:#0891b2; font-size:10pt;">(${filteredCount} hospital${filteredCount !== 1 ? 's' : ''} in this trust)</span>`;
        }
      }

      // Parse and fill address (always, since hospital determines address)
      const addressParts = parseAddress(match.address);
      const addr1 = document.getElementById('hospital_addr1');
      const addr2 = document.getElementById('hospital_addr2');
      const city  = document.getElementById('hospital_city');
      const pc    = document.getElementById('hospital_postcode');

      if (addr1) addr1.value = addressParts.line1;
      if (addr2) addr2.value = addressParts.line2;
      if (city)  city.value  = addressParts.city;
      if (pc)    pc.value    = match.postcode;

      updatePreview();
    };

    hospitalInput.addEventListener('blur', handleHospitalLookup);
    hospitalInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        handleHospitalLookup();
      }
    });
  }

  // Organisation/Trust autocomplete
  const orgInput = document.getElementById('org');
  if (orgInput){
    // Filter hospitals when organization changes
    orgInput.addEventListener('input', () => {
      const selectedTrust = orgInput.value.trim();
      // Check if it's a valid trust from our list
      const trustExists = hospitalDirectory.some(h => h.trust === selectedTrust);
      if (trustExists){
        updateHospitalList(selectedTrust);
        // Update hospital field label/hint to show filtering
        const hospitalLabel = document.querySelector('label[for="hospital_name"]');
        if (hospitalLabel){
          const filteredCount = hospitalDirectory.filter(h => h.trust === selectedTrust).length;
          hospitalLabel.innerHTML = `Hospital name <span style="color:#0891b2; font-size:10pt;">(${filteredCount} hospital${filteredCount !== 1 ? 's' : ''} in this trust)</span>`;
        }
      } else {
        updateHospitalList(); // Show all
        const hospitalLabel = document.querySelector('label[for="hospital_name"]');
        if (hospitalLabel){
          hospitalLabel.textContent = 'Hospital name';
        }
      }
    });

    const handleOrgLookup = () => {
      const orgName = orgInput.value.trim();
      if (!orgName || orgName.length < 3) return;

      const match = findTrustMatch(orgName);
      if (!match){
        updatePreview();
        return;
      }

      // Fill in trust (corrected)
      orgInput.value = match.trust;

      // Filter hospital list by selected trust
      updateHospitalList(match.trust);

      // Update hospital field label to show filtering
      const hospitalLabel = document.querySelector('label[for="hospital_name"]');
      if (hospitalLabel){
        const filteredCount = hospitalDirectory.filter(h => h.trust === match.trust).length;
        hospitalLabel.innerHTML = `Hospital name <span style="color:#0891b2; font-size:10pt;">(${filteredCount} hospital${filteredCount !== 1 ? 's' : ''} in this trust)</span>`;
      }

      // Focus hospital field to prompt user to select from filtered list
      if (hospitalInput){
        if (!hospitalInput.value.trim()){
          // Hospital field is empty, prompt user to select
          setTimeout(() => hospitalInput.focus(), 100);
        } else {
          // Hospital already has a value, verify it matches the selected trust
          const currentHospital = findHospitalMatch(hospitalInput.value);
          if (currentHospital && currentHospital.trust !== match.trust){
            // Clear hospital if it doesn't match the selected trust
            hospitalInput.value = '';
            setTimeout(() => hospitalInput.focus(), 100);
          }
        }
      }

      updatePreview();
    };

    orgInput.addEventListener('blur', handleOrgLookup);
    orgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        handleOrgLookup();
      }
    });
  }

  // Postcode lookup
  const postcodeInput = document.getElementById('hospital_postcode');
  if (postcodeInput){
    const handlePostcodeLookup = () => {
      const pc = postcodeInput.value.trim().toUpperCase();
      if (!pc || pc.length < 5) return; // Need at least 5 chars for valid UK postcode

      const match = hospitalDirectory.find(h =>
        h.postcode.toUpperCase().replace(/\s/g, '') === pc.replace(/\s/g, '')
      );

      if (!match){
        updatePreview();
        return;
      }

      // Fill in hospital name
      if (hospitalInput) hospitalInput.value = match.hospital;

      // Fill in trust
      const orgInput = document.getElementById('org');
      if (orgInput && !orgInput.value.trim()){
        orgInput.value = match.trust;
      }

      // Parse and fill address
      const addressParts = parseAddress(match.address);
      const addr1 = document.getElementById('hospital_addr1');
      const addr2 = document.getElementById('hospital_addr2');
      const city  = document.getElementById('hospital_city');

      if (addr1) addr1.value = addressParts.line1;
      if (addr2) addr2.value = addressParts.line2;
      if (city)  city.value  = addressParts.city;
      postcodeInput.value = match.postcode; // Format correctly

      updatePreview();
    };

    // Trigger on blur (when user clicks away)
    postcodeInput.addEventListener('blur', handlePostcodeLookup);

    // Also trigger on Enter key
    postcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        handlePostcodeLookup();
      }
    });
  }
});
</script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Digital Professional Endorsement</h1>
      <p>NHS Clinical Entrepreneur Programme – Candidate: Alex Monterubio</p>
    </header>
    <main>
      <!-- LEFT: WIZARD FORM -->
      <div class="panel left">
        <div class="note">
          <strong>About this form:</strong> This endorsement supports Alex Monterubio's application to the NHS Clinical Entrepreneur Programme
          (see <a href="https://www.nhscep.com" target="_blank" rel="noopener">www.nhscep.com</a>).
          The generated PDF is a professional endorsement only and <strong>does not imply financial sponsorship</strong>.
          <br/><br/>
          <strong>No data is stored by this tool – your details are used only to generate this one-off PDF and the confirmation emails.</strong>
        </div>

        <div class="steps-nav">
          <div class="steps-nav-left">
            <span id="step-counter">Step 1 of 4</span>
          </div>
          <div class="steps-nav-right">
            <div class="progress-track">
              <div class="progress-bar"></div>
            </div>
            <div class="step-labels" id="step-labels-container">
              <span class="is-active">Your details</span>
            </div>
          </div>
        </div>

        <form id="endorsement-form" onsubmit="event.preventDefault();">
          <!-- STEP 1 -->
          <div class="form-step active" data-step="1">
            <div class="section-title">Your Information</div>
            <div class="grid">
              <!-- 1. Full name -->
              <div class="col-2">
                <label for="ref_name">Your full name</label>
                <input id="ref_name" name="ref_name" required/>
              </div>

              <!-- 2. Job title/role -->
              <div class="col-2">
                <label for="ref_role">Your job title/role</label>
                <select id="ref_role" name="ref_role" required>
                  <option value="">Please select...</option>

                  <!-- Professional / Nursing Leadership -->
                  <optgroup label="Professional / Nursing Leadership">
                    <option>Head of Nursing</option>
                    <option>Associate Director of Nursing</option>
                    <option>Matron</option>
                    <option>Deputy Matron</option>
                    <option>Practice Development Nurse</option>
                    <option>Senior Team Leader</option>
                    <option>Associate Team Leader</option>
                  </optgroup>

                  <!-- Divisional / Senior Management -->
                  <optgroup label="Divisional / Senior Management">
                    <option>Divisional Operations Director</option>
                    <option>Divisional Nurse Director</option>
                    <option>Divisional/Clinical Director</option>
                    <option>Divisional General Manager</option>
                  </optgroup>

                  <!-- Service Management -->
                  <optgroup label="Service Management">
                    <option>General Manager</option>
                    <option>Deputy General Manager</option>
                    <option>Service Manager</option>
                    <option>Service Delivery Manager</option>
                    <option>Associate Service Manager</option>
                  </optgroup>

                  <!-- Operational Management -->
                  <optgroup label="Operational Management">
                    <option>Head of Perioperative Services</option>
                    <option>Perioperative Services Manager</option>
                    <option>Operations Manager</option>
                    <option>Deputy Operations Manager</option>
                    <option>Site Manager</option>
                  </optgroup>

                  <!-- Medical Staff -->
                  <optgroup label="Medical Staff">
                    <option>Consultant Surgeon</option>
                    <option>Consultant Anaesthetist</option>
                    <option>Senior Registrar</option>
                    <option>Surgical Fellow</option>
                    <option>Anaesthetic Fellow</option>
                    <option>Specialty Doctor / SAS Doctor</option>
                  </optgroup>

                  <!-- Executive Leadership -->
                  <optgroup label="Executive Leadership">
                    <option>Chief Executive Officer</option>
                    <option>Chief Operating Officer (COO)</option>
                    <option>Medical Director</option>
                    <option>Chief Nurse</option>
                    <option>Director of Nursing</option>
                  </optgroup>

                  <!-- Digital & Information Leadership -->
                  <optgroup label="Digital & Information Leadership">
                    <option>Chief Digital Information Officer (CDIO)</option>
                    <option>Chief Information Officer (CIO)</option>
                    <option>Chief Nursing Information Officer (CNIO)</option>
                    <option>Chief Clinical Information Officer (CCIO)</option>
                  </optgroup>

                  <!-- External / Custom -->
                  <optgroup label="Other">
                    <option>Other</option>
                  </optgroup>
                </select>
                <div id="ref_role_other_wrap" class="hidden" style="margin-top:6px;">
                  <input id="ref_role_other" name="ref_role_other"/>
                </div>
              </div>

              <!-- 3. Organisation -->
              <div class="col-2">
                <label for="org">Your organisation (e.g., Barts Health NHS Trust)</label>
                <input id="org" name="org" list="trust-list" autocomplete="off"/>
                <datalist id="trust-list">
                  <!-- Populated dynamically -->
                </datalist>
                <small class="hint">Type to search trusts. Anything after "NHS" will appear as the blue sub-header.</small>
              </div>

              <!-- 4. Hospital name -->
              <div class="col-2">
                <label for="hospital_name">Hospital name</label>
                <input id="hospital_name" name="hospital_name" list="hospital-list" autocomplete="off"/>
                <datalist id="hospital-list">
                  <!-- Populated dynamically -->
                </datalist>
                <small class="hint">Type to search hospitals, or enter postcode below</small>
              </div>

              <!-- 5. Hospital address -->
              <div class="col-2">
                <label>Hospital address</label>
                <div class="grid">
                  <div><input id="hospital_addr1" name="hospital_addr1" placeholder="Street address"/></div>
                  <div><input id="hospital_addr2" name="hospital_addr2" placeholder="Area (optional)"/></div>
                  <div><input id="hospital_city" name="hospital_city" placeholder="City"/></div>
                  <div>
                    <input id="hospital_postcode" name="hospital_postcode" placeholder="Postcode"/>
                    <small class="hint">Enter postcode to auto-fill hospital details</small>
                  </div>
                </div>
              </div>

              <!-- 6. Work email -->
              <div class="col-2">
                <label for="ref_email">Your work email</label>
                <input id="ref_email" name="ref_email" type="email" required/>
                <small class="hint">You'll receive a copy of the letter.</small>
              </div>

              <!-- 7. Contact number -->
              <div class="col-2">
                <label for="ref_phone">Your contact number (optional)</label>
                <input id="ref_phone" name="ref_phone" type="tel"/>
              </div>

            </div>

            <div class="actions">
              <button type="button" data-next-step="2">Next</button>
            </div>
          </div>

          <!-- STEP 2A: Custom Letter (for Other Professional Relationship) -->
          <div class="form-step hidden" data-step="2a" id="step-custom-letter">
            <div class="section-title">Your Letter of Support</div>
            <div class="note">
              Since you have a different professional relationship with Alex, please write your own letter of support below.
              Your letter will appear after "Dear NHS Clinical Entrepreneur Team," in the final PDF.
            </div>
            <div class="grid">
              <div class="col-2">
                <label for="custom_letter_text">Your letter content</label>
                <textarea id="custom_letter_text" name="custom_letter_text" style="min-height: 300px;"></textarea>
                <small class="hint">Write your full letter content here. Include why you're supporting Alex, examples of their work, and why they're suitable for the NHS Clinical Entrepreneur Programme.</small>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="1">Back</button>
              <button type="button" onclick="goToFinalStep()">Next</button>
            </div>
          </div>

          <!-- STEP 2: Relationship & Role -->
          <div class="form-step" data-step="2" id="step-relationship">
            <div class="section-title">Relationship & Role</div>
            <div class="grid">
              <!-- Professional relationship -->
              <div class="col-2">
                <label for="professional_area">What is your professional relationship to Alex?</label>
                <select id="professional_area" name="professional_area" required>
                  <option value="">Please select...</option>
                  <option value="perioperative">Perioperative/Theatre Colleague</option>
                  <option value="different">Other Professional Relationship</option>
                </select>
              </div>

              <!-- FOR PERIOPERATIVE: Dropdown capacity -->
              <div class="col-2 hidden" id="perioperative_capacity_wrap">
                <label for="relationship">In what capacity have you worked with Alex?</label>
                <select id="relationship" name="relationship">
                  <option value="">Please select...</option>
                  <option>Senior Line Manager</option>
                  <option>Line Manager</option>
                  <option>Senior Clinician</option>
                  <option>Peer / Team Leader</option>
                  <option>Service/Operations Manager</option>
                  <option>Senior Nursing Colleague</option>
                  <option>Senior Clinical Colleague</option>
                  <option>Professional Colleague</option>
                  <option>Clinical Supervisor</option>
                  <option>Senior Clinical Colleague from Locum Assignments</option>
                </select>
              </div>

              <!-- FOR OTHER: Free text capacity -->
              <div class="col-2 hidden" id="other_capacity_wrap">
                <label for="other_relationship_capacity">Please specify what capacity you have worked with Alex</label>
                <input id="other_relationship_capacity" name="other_relationship_capacity"/>
                <small class="hint">Describe your professional relationship with Alex.</small>
              </div>

              <!-- Duration (shown for both) -->
              <div class="col-2">
                <label for="q_duration_select"><span id="duration_label">How long have you known or worked with Alex?</span></label>
                <select id="q_duration_select" name="q_duration_select" required onchange="toggleDurationDetail()">
                  <option value="">Please select...</option>
                  <option value="less than six months">Less than six months</option>
                  <option value="between six and twelve months">Between six and twelve months</option>
                  <option value="between one and three years">Between one and three years</option>
                  <option value="more than three years">More than three years</option>
                  <option value="other">Other (please add a short description below)</option>
                </select>
                <div id="duration_detail_wrap" class="hidden" style="margin-top:8px;">
                  <input id="q_duration_detail" name="q_duration_detail"/>
                  <small class="hint">This will be turned into a narrative sentence in the letter.</small>
                </div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="1">Back</button>
              <button type="button" data-next-step="3">Next</button>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="form-step" data-step="3">
            <div class="section-title">Professional Endorsement</div>
            <div class="grid">
              <!-- Q1: Motivation for innovation -->
              <div class="col-2">
                <label>How would you describe Alex's motivation for pursuing innovation within the NHS? (Select all that apply)</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="demonstrates genuine interest in improving patient pathways or staff workflows">
                    <span>Demonstrates genuine interest in improving patient pathways or staff workflows</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="actively seeks opportunities to solve practical operational challenges">
                    <span>Actively seeks opportunities to solve practical operational challenges</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="shows persistence when exploring new ideas or approaches">
                    <span>Shows persistence when exploring new ideas or approaches</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="displays curiosity and willingness to learn from others">
                    <span>Displays curiosity and willingness to learn from others</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="responds positively to feedback and uses it to refine ideas">
                    <span>Responds positively to feedback and uses it to refine ideas</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="motivated by improving safety, efficiency, or patient experience">
                    <span>Motivated by improving safety, efficiency, or patient experience</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="able to balance ambition with realistic expectations">
                    <span>Able to balance ambition with realistic expectations</span>
                  </label>
                </div>
              </div>

              <!-- Q2: Professional strengths -->
              <div class="col-2">
                <label>Which statements best describe Alex's professional strengths and capability? (Select all that apply)</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="communicates clearly with clinical and non-clinical colleagues">
                    <span>Communicates clearly with clinical and non-clinical colleagues</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="demonstrates sound clinical judgement within their scope of practice">
                    <span>Demonstrates sound clinical judgement within their scope of practice</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="organises work effectively and manages competing priorities">
                    <span>Organises work effectively and manages competing priorities</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="learns new concepts quickly and applies them appropriately">
                    <span>Learns new concepts quickly and applies them appropriately</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="works reliably and maintains professional standards">
                    <span>Works reliably and maintains professional standards</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="shows resilience when facing setbacks or operational pressures">
                    <span>Shows resilience when facing setbacks or operational pressures</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="professional_strengths" value="demonstrates leadership behaviours appropriate to current role">
                    <span>Demonstrates leadership behaviours appropriate to current role</span>
                  </label>
                </div>
              </div>

              <!-- Q3: Clinical impact potential -->
              <div class="col-2">
                <label>In your view, what is Alex's potential for creating meaningful clinical impact? (Select all that apply)</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="identifies inefficiencies or gaps in current clinical processes">
                    <span>Identifies inefficiencies or gaps in current clinical processes</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="understands practical realities of frontline NHS workflows">
                    <span>Understands practical realities of frontline NHS workflows</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="considers safety, quality, and patient experience when designing ideas">
                    <span>Considers safety, quality, and patient experience when designing ideas</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="engages colleagues constructively when discussing improvements">
                    <span>Engages colleagues constructively when discussing improvements</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="recognises risks and is willing to escalate concerns appropriately">
                    <span>Recognises risks and is willing to escalate concerns appropriately</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="demonstrates an understanding of multidisciplinary team dynamics">
                    <span>Demonstrates an understanding of multidisciplinary team dynamics</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="clinical_impact" value="shows potential to contribute to service improvement initiatives">
                    <span>Shows potential to contribute to service improvement initiatives</span>
                  </label>
                </div>
              </div>

              <!-- Q4: NHS priorities alignment -->
              <div class="col-2">
                <label>How well does Alex's idea align with current NHS priorities? (Select all that apply)</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="addresses a known challenge in efficiency or resource use">
                    <span>Addresses a known challenge in efficiency or resource use</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="supports improved patient flow, waiting list recovery, or productivity">
                    <span>Supports improved patient flow, waiting list recovery, or productivity</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="aligns with digital transformation ambitions">
                    <span>Aligns with digital transformation ambitions</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="could reduce unnecessary workload or duplication">
                    <span>Could reduce unnecessary workload or duplication</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="could improve communication or coordination across teams">
                    <span>Could improve communication or coordination across teams</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="has potential to enhance patient safety or reduce variation">
                    <span>Has potential to enhance patient safety or reduce variation</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="nhs_priorities" value="could contribute to long-term sustainability">
                    <span>Could contribute to long-term sustainability</span>
                  </label>
                </div>
              </div>

              <!-- Q5: Innovation viability -->
              <div class="col-2">
                <label>How viable do you think Alex's proposed innovation is at this stage? (Select all that apply)</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="the idea addresses a clear and realistic problem">
                    <span>The idea addresses a clear and realistic problem</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="early concept appears practical for real-world NHS environments">
                    <span>Early concept appears practical for real-world NHS environments</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="the solution seems achievable with appropriate mentoring/support">
                    <span>The solution seems achievable with appropriate mentoring/support</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="risks and barriers appear manageable">
                    <span>Risks and barriers appear manageable</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="potential benefit outweighs likely implementation challenges">
                    <span>Potential benefit outweighs likely implementation challenges</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="Alex is open to adapting the idea as new insight emerges">
                    <span>Alex is open to adapting the idea as new insight emerges</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="innovation_viability" value="further development is required but direction is promising">
                    <span>Further development is required but direction is promising</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="2">Back</button>
              <button type="button" data-next-step="4">Next</button>
            </div>
          </div>

          <!-- STEP 4 -->
          <div class="form-step" data-step="4">
            <div class="section-title">Date & Signature</div>
            <div class="grid">
              <div>
                <label for="date_line">Letter date</label>
                <input id="date_line" name="date_line"/>
              </div>
            </div>

            <div class="section-title">Sign Your Letter</div>
            <div class="col-2">
              <label>Draw your signature below</label>
              <div class="sig-wrap">
                <div style="position:relative;">
                  <canvas id="signature-canvas" class="sig-canvas"></canvas>
                  <div id="sig-watermark" class="sig-watermark">Sign here</div>
                </div>
                <div class="sig-row">
                  <div class="sig-actions">
                    <button type="button" id="clear-signature-btn" class="ghost">Clear</button>
                  </div>
                  <small class="hint">Use your mouse, trackpad, or touchscreen to sign</small>
                </div>
              </div>
            </div>

            <div style="margin-top:16px; padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px;">
              <label style="display:flex; align-items:start; gap:10px; margin:0;">
                <input type="checkbox" required style="width:auto; margin-top:3px;"/>
                <span style="flex:1;">I confirm this endorsement is accurate and consent to its electronic submission to Alex Monterubio for the NHS Clinical Entrepreneur Programme. This serves as my digital signature.</span>
              </label>
            </div>

            <div class="section-title">Submit Your Letter</div>
            <div class="actions">
              <button type="button" class="secondary" data-prev-step="3">Back</button>
              <button type="button" onclick="handleSubmit()">Submit Letter</button>
              <button type="button" class="ghost" onclick="updatePreview()">Refresh Preview</button>
            </div>
            <small class="hint">On submit: a PDF will download to your computer and can be emailed via your configured backend (e.g., Resend on Vercel).</small>
          </div>
        </form>
      </div>

      <!-- RIGHT: PREVIEW -->
      <div class="panel">
        <div class="preview-wrap">
          <div id="preview"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <h4>Thank you for your endorsement</h4>
    <p>Your digital letter of support has been generated successfully.</p>
    <p>A secure PDF copy has been downloaded to your device.</p>
    <p><em>— With appreciation, Alex Monterubio</em></p>
  </div>
</body>
</html>
