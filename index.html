<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>NHS Clinical Entrepreneur Programme – Digital Professional Endorsement</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{ --brand:#2563eb; --ink:#1f2937; --muted:#6b7280; --bg:#f9fafb; --line:#e5e7eb; }
*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  line-height:1.6;
}
.hidden{ display:none !important; }

.container{
  max-width:1400px;
  margin:10px auto;
  background:#fff;
  border:1px solid var(--line);
  border-radius:6px;
  box-shadow:0 1px 3px rgba(0,0,0,.06);
  overflow:hidden;
  min-height: calc(100vh - 20px);
  display:flex;
  flex-direction:column;
}
header{
  padding:16px 20px;
  border-bottom:1px solid var(--line);
  background:#000;
}
header h1{
  margin:0 0 4px;
  font-size:20px;
  font-weight:700;
  color:#fff;
}
header p{
  margin:0;
  color:#d1d5db;
  font-size:13px;
}
main{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:0;
  min-height: 0;
  flex:1;
}
.panel{
  padding:16px 20px;
  overflow:auto;
}
.left{
  border-right:1px solid var(--line);
  background: #e5e7eb;
}

.section-title{
  font-size:15px;
  font-weight:700;
  color:var(--ink);
  margin:16px 0 8px;
  padding-bottom:6px;
  border-bottom:2px solid var(--line);
}
.section-title:first-child{ margin-top:0; }

label{
  display:block;
  font-weight:500;
  margin:10px 0 4px;
  font-size:13px;
  color:var(--ink);
}
input,select,textarea{
  width:100%;
  padding:8px 10px;
  border:2px solid #0891b2;
  border-radius:4px;
  font-size:16px; /* Prevent iOS auto-zoom on focus */
  font-family:inherit;
  background:#ffffff;
  box-shadow:0 1px 2px rgba(8,145,178,0.1);
  transition:all 0.2s;
  -webkit-appearance:none;
  -moz-appearance:none;
  appearance:none;
  min-height:40px;
}
/* Custom checkbox styling for better visibility */
input[type="checkbox"]{
  -webkit-appearance:checkbox;
  -moz-appearance:checkbox;
  appearance:checkbox;
  width:20px;
  min-width:20px;
  min-height:20px;
  height:20px;
  margin:0;
  cursor:pointer;
  accent-color:#0891b2;
  flex-shrink:0;
  transform:scale(1.1); /* Slightly larger for better visibility */
}

/* Custom radio button styling for better visibility */
input[type="radio"]{
  -webkit-appearance:radio;
  -moz-appearance:radio;
  appearance:radio;
  width:20px;
  min-width:20px;
  min-height:20px;
  height:20px;
  margin:0;
  cursor:pointer;
  accent-color:#0891b2;
  flex-shrink:0;
  transform:scale(1.2); /* Slightly larger for better visibility */
}

/* Input field wrapper for clear button */
.input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}
.input-wrapper input {
  width: 100%;
  padding-right: 36px; /* Make room for clear button */
}
.input-clear-btn {
  position: absolute;
  right: 8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #94a3b8;
  border: none;
  color: white;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  padding: 0;
  line-height: 1;
}
.input-clear-btn:hover {
  background: #64748b;
}
.input-wrapper.has-value .input-clear-btn {
  display: flex;
}

/* iOS-style toggle switches */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  vertical-align: middle;
  margin-right: 8px;
}

/* Hide default checkbox inside switch */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* Slider background */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d1d5db;
  border-radius: 24px;
  transition: 0.3s;
}

/* Circle */
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* When checked */
.switch input:checked + .slider {
  background-color: #0891b2;
}

.switch input:checked + .slider:before {
  transform: translateX(20px);
}

/* Label styling for toggles */
.toggle-label {
  display: inline-flex;
  align-items: center;
  cursor: pointer;
  font-size: 11pt;
  color: #374151;
  user-select: none;
}

select{
  background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230891b2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat:no-repeat;
  background-position:right 8px center;
  background-size:16px;
  padding-right:32px;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#0e7490;
  box-shadow:0 0 0 2px rgba(6,182,212,0.15), 0 2px 4px rgba(8,145,178,0.12);
}
textarea{ min-height:80px; resize:vertical; }
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.col-2{ grid-column:span 2; }
small.hint{
  color:var(--muted);
  display:block;
  margin-top:3px;
  font-size:11px;
  line-height:1.3;
}
.note{
  background: linear-gradient(135deg, #dbeafe 0%, #cffafe 50%, #e9d5ff 100%);
  border:1px solid #a5b4fc;
  padding:10px 12px;
  border-radius:4px;
  font-size:12px;
  margin-bottom:12px;
  line-height:1.5;
  color:#1e293b;
}
.note a{ color:#2563eb; text-decoration:underline; }

.inline-option{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:400;
  margin-top:6px;
  font-size:15px;
  padding:10px 12px;
  border-radius:6px;
  cursor:pointer;
  transition:background 0.15s;
}
.inline-option:hover{
  background:#f0f9ff;
}
.inline-option input{
  width:auto;
  margin:0;
}
.inline-option span{
  user-select:none;
}

/* Letter mode choice styling */
.letter-mode-choice{
  margin-bottom:24px;
  padding:20px;
  background:#f0f9ff;
  border-radius:8px;
  border:2px solid #0891b2;
}
.letter-mode-title{
  font-weight:700;
  font-size:16px;
  display:block;
  margin-bottom:16px;
  color:#0f172a;
}
.letter-mode-options{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.letter-mode-option{
  display:flex;
  align-items:flex-start;
  gap:12px;
  background:white;
  padding:16px;
  border-radius:6px;
  cursor:pointer;
  transition:all 0.2s;
  border:2px solid transparent;
}
.letter-mode-option:hover{
  border-color:#0891b2;
  box-shadow:0 2px 6px rgba(8,145,178,0.1);
}
.letter-mode-option input[type="radio"]{
  margin-top:2px;
}
.letter-mode-content{
  display:flex;
  flex-direction:column;
  gap:4px;
  flex:1;
}
.letter-mode-label{
  font-weight:600;
  font-size:15px;
  color:#0f172a;
  display:block;
}
.letter-mode-desc{
  font-size:14px;
  color:#64748b;
  line-height:1.4;
  display:block;
}

/* Mobile adjustments for letter mode choice */
@media (max-width: 640px){
  .letter-mode-choice{
    padding:16px;
  }
  .letter-mode-title{
    font-size:15px;
    margin-bottom:12px;
  }
  .letter-mode-option{
    padding:12px;
    gap:10px;
  }
  .letter-mode-label{
    font-size:14px;
  }
  .letter-mode-desc{
    font-size:13px;
  }
}

/* Stepper nav */
.steps-nav{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.steps-nav-left{
  font-size:12px;
  font-weight:500;
  color:var(--ink);
}
.steps-nav-right{
  flex:1;
  margin-left:12px;
}
.progress-track{
  width:100%;
  height:4px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
}
.progress-bar{
  height:100%;
  width:0%;
  background:var(--brand);
  transition:width .25s ease;
}
.step-labels{
  display:flex;
  justify-content:space-between;
  margin-top:4px;
  font-size:10px;
  color:var(--muted);
}
.step-labels span.is-active{
  color:var(--brand);
  font-weight:600;
}

/* Steps */
.form-step{
  display:none;
  animation:fadeIn .2s ease;
}
.form-step.active{
  display:block;
}
@keyframes fadeIn{
  from{ opacity:0; transform:translateY(4px); }
  to{ opacity:1; transform:translateY(0); }
}

.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
button{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:4px;
  font-weight:600;
  cursor:pointer;
  font-size:13px;
  transition:background 0.2s;
}
button:hover{ background:#1d4ed8; }
button.secondary{
  background:#f3f4f6;
  color:var(--ink);
  border:1px solid var(--line);
}
button.secondary:hover{ background:#e5e7eb; }
button.ghost{
  background:#fff;
  color:#1f2937;
  border:1px solid #d1d5db;
}
button.ghost:hover{ background:#f9fafb; }

/* Signature pad - DocuSign style */
.sig-wrap{
  border:2px solid #fbbf24;
  border-radius:6px;
  background:linear-gradient(to bottom, #fffbeb 0%, #fef3c7 100%);
  padding:12px;
  position:relative;
  box-shadow:0 2px 4px rgba(251,191,36,0.2);
}
.sig-row{
  display:flex;
  gap:8px;
  align-items:center;
  margin-top:8px;
}
.sig-canvas{
  width:100%;
  height:160px;
  background:#fffef8;
  border:2px solid #0891b2;
  border-radius:8px;
  position:relative;
  cursor:crosshair;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1), inset 0 0 0 1px rgba(8,145,178,0.1);
  transition: all 0.2s ease;
}
.sig-canvas:hover{
  border-color:#0e7490;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(8,145,178,0.2);
}
.sig-watermark{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  color:#94a3b8;
  font-size:18px;
  font-weight:600;
  pointer-events:none;
  user-select:none;
  display:flex;
  align-items:center;
  gap:12px;
  letter-spacing:0.5px;
}
.sig-watermark::before{
  content:'✓';
  font-size:28px;
  color:#0891b2;
  font-weight:bold;
  opacity:0.6;
}
.sig-actions{
  display:flex;
  gap:6px;
}

/* Preview page - 1:1 scale for accurate print representation */
.preview-wrap{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding: 30px 20px;
  width: 100%;
  min-height: 100%;
  overflow-y: scroll; /* Vertical scroll only */
  overflow-x: hidden; /* No horizontal panning */
  -webkit-overflow-scrolling: touch;
  touch-action: pan-y pinch-zoom; /* Allow vertical scroll and pinch zoom */
  background: #e5e7eb; /* Print preview gray background */
}
/* Allow zoom on preview only (double-tap or pinch) */
.preview-wrap .paper{
  cursor: zoom-in;
  touch-action: pinch-zoom; /* Enable pinch-zoom on preview */
}
.paper{
  width: 210mm;
  max-width: 100%; /* Fit container width */
  background: transparent;
  position: relative;
  zoom: 0.65; /* Scale down to show whole page */
  transform-origin: top center;
}
.paper .page{
  width: 100%; /* Match parent width */
  max-width: 210mm; /* Cap at A4 width */
  min-height: 297mm; /* A4 height */
  padding: 15mm 20mm 20mm 20mm;
  margin-bottom: 25px; /* Gap between pages like print preview */
  font-family: Arial, sans-serif;
  color: #000000;
  line-height: 1.5;
  font-size: 11pt;
  page-break-after: always;
  break-after: page;
  position: relative;
  background: #ffffff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.1); /* Print preview shadow */
  border: none;
}

/* Last page shouldn't have bottom margin */
.paper .page:last-child{
  margin-bottom: 0;
}

/* Mobile preview adjustments */
@media (max-width: 980px){
  .preview-wrap{
    padding: 10px;
    justify-content: flex-start;
  }
  .paper{
    width: 100%; /* Full container width on mobile */
    max-width: 210mm; /* Cap at A4 width */
    min-height: 297mm;
  }
  .paper .page{
    padding: 15mm 20mm;
    font-size: 11pt;
  }
}

/* Sender, header, date, recipient, subject */
.sender-block{
  font-family: Arial, sans-serif;
  font-size: 11pt;
  line-height:1.4;
  text-align:left;
  margin: 0 0 4px 0;
}
.header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}
.header-block {
  display: flex;
  justify-content: flex-end;
  padding: 0;
  font-family: Arial, sans-serif;
}
.trust-header { text-align: right; }

/* NHS logo image */
.nhs-logo-img{
  display:block;
  width:72px;
  height:auto;
  margin-left:auto;
}

/* trust text bits */
.trust-header .trust-name {
  font-size: 18px;
  font-weight: bold;
  margin-top: 6px;
  color: #000;
}
.trust-header .trust-sub {
  font-size: 11pt;
  font-weight: bold;
  color: #1D8FDB;
}
.trust-header .trust-hospital {
  font-size: 14px;
  font-weight: 600;
  color: #000;
  margin-top: 10px;
}
.trust-header .trust-address {
  font-size: 11pt;
  font-weight: 400;
  color: #000;
  margin-top: 6px;
  line-height: 1.4;
}

.letter-date{
  font-size: 11pt;
  margin-top: 12px;
  margin-bottom: 12px;
  text-align:left;
}

.recipient-block{
  font-size: 11pt;
  line-height: 1.4;
  margin-bottom: 8px;
}
.recipient-subject{
  font-size: 11pt;
  font-weight:bold;
  margin-bottom:12px;
}

.letter-body p{
  margin: 0 0 9pt;
}
.letter-body p.sal{
  margin-top: 10pt;
  font-weight:500;
}
.letter-closing{ margin-top: 14pt; }
.letter-sign{ margin-top: 10pt; height: 60px; }
.letter-sign img{
  max-height: 60px;
  max-width: 100%;
  object-fit: contain;
}
.letter-signoff{ margin: 8pt 0 0; }
.letter-signoff .name{ font-weight:700; }

/* Ensure all images in letter fit within A4 */
.paper .page img{
  max-width: 100%;
  height: auto;
}

/* Toast */
.toast {
  position: fixed;
  left: 50%;
  bottom: 24px;
  transform: translateX(-50%) translateY(20px);
  background: var(--brand);
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.2);
  width: min(680px, calc(100% - 32px));
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .35s ease, transform .35s ease;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}
.toast h4 {
  margin: 0 0 4px;
  font-size: 16px;
  font-weight: 700;
}
.toast p {
  margin: 0;
  line-height: 1.45;
  font-size: 14px;
}
.toast p + p { margin-top: 4px; }
.toast em { opacity: .95; }

/* Loading overlay with animated logo */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.loading-overlay.show {
  display: flex;
  opacity: 1;
}
.loading-content {
  text-align: center;
  animation: fadeInUp 0.5s ease;
}
.loading-logo {
  width: 120px;
  height: 120px;
  margin: 0 auto 24px;
  animation: spinGlow 2s ease-in-out infinite;
  filter: drop-shadow(0 0 20px rgba(8, 145, 178, 0.6));
}
.loading-text {
  color: white;
}
.loading-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
  color: #fff;
  animation: pulse 1.5s ease-in-out infinite;
}
.loading-subtitle {
  font-size: 14px;
  color: #cbd5e1;
}

/* Spin and glow animation */
@keyframes spinGlow {
  0%, 100% {
    transform: rotate(0deg) scale(1);
    filter: drop-shadow(0 0 20px rgba(8, 145, 178, 0.6));
  }
  25% {
    filter: drop-shadow(0 0 30px rgba(8, 145, 178, 0.8)) drop-shadow(0 0 40px rgba(8, 145, 178, 0.4));
  }
  50% {
    transform: rotate(180deg) scale(1.05);
    filter: drop-shadow(0 0 35px rgba(8, 145, 178, 1)) drop-shadow(0 0 50px rgba(8, 145, 178, 0.5));
  }
  75% {
    filter: drop-shadow(0 0 30px rgba(8, 145, 178, 0.8)) drop-shadow(0 0 40px rgba(8, 145, 178, 0.4));
  }
  100% {
    transform: rotate(360deg) scale(1);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

/* Disabled option style for "over 3" */
.inline-option.disabled-option{
  opacity:0.55;
  pointer-events:none;
}

/* Print */
@media print{
  body{ background:#fff; }
  .container{ border:0; box-shadow:none; }
  main{ display:block; }
  .left{ display:none; }
  .panel{ padding:0; }
  .paper{ box-shadow:none; border:0; width:auto; min-height:auto; }
  .paper .page{ padding: 15mm 20mm; }
}

/* Responsive */
@media (max-width: 980px){
  main{ grid-template-columns: 1fr; }
  .left{ border-right:0; border-bottom:1px solid var(--line); }
  .grid{ grid-template-columns: 1fr; }
  .col-2{ grid-column: span 1; }
}

/* Submit status animation */
.submit-status{
  display: none;
  text-align: center;
  padding: 12px 16px;
  margin: 16px 0;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
}
.submit-status.active{
  display: block;
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
  animation: pulse 1.5s ease-in-out infinite;
}
.submit-status.success{
  display: block;
  background: #dcfce7;
  color: #166534;
  border: 1px solid #86efac;
  animation: none;
}
.submit-status.error{
  display: block;
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #fca5a5;
  animation: none;
}
@keyframes pulse{
  0%, 100%{ opacity: 1; }
  50%{ opacity: 0.7; }
}
</style>

<!-- external libs for PDF & canvas -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
// --- CONFIG: adjust if you want to call your Vercel API/Resend endpoint ---
const BACKEND_ENDPOINT = "/api/send-letter"; // change or remove if not needed

// Opening paragraphs by role (for key roles; others get generic)
const openingsByRole = {
  // Executive
  "Chief Executive Officer":
    "As Chief Executive Officer of our organisation, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Nurse":
    "In my capacity as Chief Nurse, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Medical Director":
    "In my role as Medical Director, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Director of Nursing":
    "As Director of Nursing, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Operating Officer (COO)":
    "In my capacity as Chief Operating Officer (COO), I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Digital & information
  "Chief Information Officer (CIO)":
    "As Chief Information Officer (CIO) for our organisation, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Nursing Information Officer (CNIO)":
    "In my capacity as Chief Nursing Information Officer (CNIO), I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Clinical Information Officer (CCIO)":
    "As Chief Clinical Information Officer (CCIO), I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Chief Digital Information Officer (CDIO)":
    "In my role as Chief Digital Information Officer (CDIO), I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Divisional / senior management
  "Divisional Operations Director":
    "As Divisional Operations Director, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Divisional General Manager":
    "As Divisional General Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Divisional/Clinical Director":
    "In my capacity as Divisional/Clinical Director, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Divisional Nurse Director":
    "As Divisional Nurse Director, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Service management
  "General Manager":
    "As General Manager for the service, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Deputy General Manager":
    "As Deputy General Manager, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Service Manager":
    "As Service Manager for the department, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Associate Service Manager":
    "In my role as Associate Service Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Service Delivery Manager":
    "In my role as Service Delivery Manager for Theatres at the Royal London Hospital, Barts Health NHS Trust, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader within the department.",

  // Operational management
  "Head of Perioperative Services":
    "As Head of Perioperative Services at the Royal London Hospital, Barts Health NHS Trust, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres.",
  "Perioperative Services Manager":
    "In my role as Perioperative Services Manager, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Operations Manager":
    "As Operations Manager for perioperative services, I am pleased to support Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Deputy Operations Manager":
    "In my role as Deputy Operations Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Site Manager":
    "As Site Manager, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Professional / nursing leadership
  "Associate Director of Nursing":
    "In my capacity as Associate Director of Nursing, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Head of Nursing":
    "As Head of Nursing, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Matron":
    "As Matron for the Theatre Department, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Deputy Matron":
    "In my role as Deputy Matron, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Practice Development Nurse":
    "In my role as Practice Development Nurse, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Senior Team Leader":
    "In my capacity as a Senior Team Leader in theatres, I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Associate Team Leader":
    "As an Associate Team Leader within the perioperative service, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",

  // Medical staff
  "Consultant Anaesthetist":
    "I am pleased to provide a letter of support for Alex Monterubio, with whom I worked during theatre sessions at the Royal London Hospital, Barts Health NHS Trust, where Alex previously held the position of Senior Team Leader in Theatres.",
  "Consultant Surgeon":
    "As a Consultant Surgeon at the Royal London Hospital, Barts Health NHS Trust, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres.",
  "Senior Registrar":
    "I am pleased to provide a letter of support for Alex Monterubio, whom I had the opportunity to work with during surgical lists at the Royal London Hospital, Barts Health NHS Trust, where Alex previously worked as a Senior Team Leader in Theatres.",
  "Surgical Fellow":
    "As a Surgical Fellow working within the theatre environment, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Anaesthetic Fellow":
    "As an Anaesthetic Fellow, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.",
  "Specialty Doctor / SAS Doctor":
    "As a Specialty (SAS) Doctor working regularly in theatres, I am pleased to provide this letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust."
};

// London hospitals directory - embedded data (short example list)
let hospitalDirectory = [
  {"hospital":"The Royal London Hospital","trust":"Barts Health NHS Trust","address":"Whitechapel Road, Whitechapel, London","postcode":"E1 1FR"},
  {"hospital":"St Bartholomew's Hospital","trust":"Barts Health NHS Trust","address":"West Smithfield, London","postcode":"EC1A 7BE"},
  {"hospital":"Whipps Cross University Hospital","trust":"Barts Health NHS Trust","address":"Whipps Cross Road, Leytonstone, London","postcode":"E11 1NR"},
  {"hospital":"Newham University Hospital","trust":"Barts Health NHS Trust","address":"Glen Road, Plaistow, London","postcode":"E13 8SL"},
  {"hospital":"Guy's Hospital","trust":"Guy's and St Thomas' NHS Foundation Trust","address":"Great Maze Pond, London","postcode":"SE1 9RT"},
  {"hospital":"St Thomas' Hospital","trust":"Guy's and St Thomas' NHS Foundation Trust","address":"Westminster Bridge Road, London","postcode":"SE1 7EH"},
  {"hospital":"King's College Hospital","trust":"King's College Hospital NHS Foundation Trust","address":"Denmark Hill, London","postcode":"SE5 9RS"},
  {"hospital":"University College Hospital","trust":"University College London Hospitals NHS Foundation Trust","address":"235 Euston Road, London","postcode":"NW1 2BU"},
  {"hospital":"Hammersmith Hospital","trust":"Imperial College Healthcare NHS Trust","address":"Du Cane Road, London","postcode":"W12 0HS"},
  {"hospital":"St George's Hospital","trust":"St George's University Hospitals NHS Foundation Trust","address":"Blackshaw Road, Tooting, London","postcode":"SW17 0QT"}
];

function parseAddress(addressStr){
  const parts = addressStr.split(',').map(s => s.trim());
  if (parts.length === 1){
    return { line1: parts[0], line2: "", city: "" };
  } else if (parts.length === 2){
    return { line1: parts[0], line2: "", city: parts[1] };
  } else {
    return {
      line1: parts[0],
      line2: parts.slice(1, -1).join(', '),
      city: parts[parts.length - 1]
    };
  }
}

// Normalize text for fuzzy matching
function normalizeText(text){
  return text
    .toLowerCase()
    .replace(/['']/g, "'")
    .replace(/\s+/g, ' ')
    .trim();
}

// Fuzzy match scoring
function fuzzyScore(search, target){
  const searchNorm = normalizeText(search);
  const targetNorm = normalizeText(target);

  if (searchNorm === targetNorm) return 100;
  if (targetNorm.includes(searchNorm)) return 80;
  if (searchNorm.includes(targetNorm)) return 70;

  const searchWords = searchNorm.split(' ').filter(w => w.length > 2);
  const targetWords = targetNorm.split(' ');

  const matchedWords = searchWords.filter(sw =>
    targetWords.some(tw => tw.includes(sw) || sw.includes(tw))
  );

  if (matchedWords.length === searchWords.length && searchWords.length > 0){
    return 60;
  }

  if (matchedWords.length > 0){
    return 40 * (matchedWords.length / searchWords.length);
  }

  return 0;
}

function findHospitalMatch(name){
  if (!name || !hospitalDirectory.length) return null;

  const matches = hospitalDirectory.map(h => ({
    hospital: h,
    score: fuzzyScore(name, h.hospital)
  })).filter(m => m.score > 30);

  matches.sort((a, b) => b.score - a.score);

  return matches.length > 0 ? matches[0].hospital : null;
}

function findTrustMatch(orgName){
  if (!orgName || !hospitalDirectory.length) return null;

  const matches = hospitalDirectory.map(h => ({
    hospital: h,
    score: fuzzyScore(orgName, h.trust)
  })).filter(m => m.score > 30);

  matches.sort((a, b) => b.score - a.score);

  return matches.length > 0 ? matches[0].hospital : null;
}

// trust splitter
function splitTrust(orgValue){
  if (!orgValue) return { main:"", sub:"" };
  const v = orgValue.trim();
  const idx = v.indexOf(" NHS");
  if (idx === -1){
    return { main: v, sub: "" };
  }
  return {
    main: v.slice(0, idx).trim(),
    sub:  v.slice(idx + 1).trim()
  };
}

// date helpers
function todayUK(){
  const opts = { day: 'numeric', month: 'long', year: 'numeric' };
  return new Date().toLocaleDateString('en-GB', opts);
}
function todayUKISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function toUKLong(dateISO){
  try{
    const d = new Date(dateISO);
    if (isNaN(d)) return todayUK();
    return d.toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' });
  }catch(e){ return todayUK(); }
}

let sigPad;
let currentStep = 1;
const totalSteps = 4;

// Utility: join array into academic-style list
function joinAsAcademicList(items){
  if (!items || !items.length) return "";
  if (items.length === 1) return items[0];
  if (items.length === 2) return `${items[0]} and ${items[1]}`;
  return `${items.slice(0, -1).join(", ")}, and ${items[items.length - 1]}`;
}

function readForm(){
  const motivationSelected = Array.from(
    document.querySelectorAll('input[name="motivation"]:checked')
  ).map(el => el.value);

  const capabilitySelected = Array.from(
    document.querySelectorAll('input[name="capability"]:checked')
  ).map(el => el.value);

  const impactSelected = Array.from(
    document.querySelectorAll('input[name="impact"]:checked')
  ).map(el => el.value);

  const prioritySelected = Array.from(
    document.querySelectorAll('input[name="priority"]:checked')
  ).map(el => el.value);

  const viabilitySelected = Array.from(
    document.querySelectorAll('input[name="viability"]:checked')
  ).map(el => el.value);

  return {
    refName: document.getElementById('ref_name').value.trim(),
    refRole: document.getElementById('ref_role').value,
    refRoleOther: (document.getElementById('ref_role_other')?.value || "").trim(),
    org: document.getElementById('org').value.trim(),
    email: document.getElementById('ref_email').value.trim(),
    phone: document.getElementById('ref_phone').value.trim(),

    professionalArea: (document.getElementById('professional_area')?.value || ""),
    relationship: (document.getElementById('relationship')?.value || ""),
    otherRelationshipCapacity: (document.getElementById('other_relationship_capacity')?.value || "").trim(),
    customLetterText: (document.getElementById('custom_letter_text')?.value || "").trim(),

    hospitalName: (document.getElementById('hospital_name')?.value || "").trim(),
    hospitalAddr1: (document.getElementById('hospital_addr1')?.value || "").trim(),
    hospitalAddr2: (document.getElementById('hospital_addr2')?.value || "").trim(),
    hospitalCity: (document.getElementById('hospital_city')?.value || "").trim(),
    hospitalPostcode: (document.getElementById('hospital_postcode')?.value || "").trim(),

    useHeader: true, // Always include NHS header
    dateLine: (document.getElementById('date_line')?.value || "").trim(),

    qDurationSelect: (document.getElementById('q_duration_select')?.value || ""),
    qDurationDetail: (document.getElementById('q_duration_detail')?.value || "").trim(),

    motivationSelected,
    motivationOther: (document.getElementById('motivation_other')?.value || "").trim(),

    capabilitySelected,
    capabilityOther: (document.getElementById('capability_other')?.value || "").trim(),

    impactSelected,
    impactOther: (document.getElementById('impact_other')?.value || "").trim(),

    prioritySelected,
    priorityOther: (document.getElementById('priority_other')?.value || "").trim(),

    viabilitySelected,
    viabilityOther: (document.getElementById('viability_other')?.value || "").trim(),

    // Custom writing mode fields
    letterMode: document.querySelector('input[name="letter_mode"]:checked')?.value || 'template',
    customOpening: (document.getElementById('custom_opening')?.value || "").trim(),
    customMotivation: (document.getElementById('custom_motivation')?.value || "").trim(),
    customCapability: (document.getElementById('custom_capability')?.value || "").trim(),
    customImpact: (document.getElementById('custom_impact')?.value || "").trim(),
    customPriority: (document.getElementById('custom_priority')?.value || "").trim(),
    customViability: (document.getElementById('custom_viability')?.value || "").trim()
  };
}

/* Step validation – only for the visible step */
function validateStep(stepNumber){
  const stepEl = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
  if (!stepEl) return true;

  const fields = stepEl.querySelectorAll('input, select, textarea');
  fields.forEach(el => { el.style.borderColor = '#d1d5db'; });

  let valid = true;
  let firstProblem = null;

  const required = stepEl.querySelectorAll('[required]');
  required.forEach(el => {
    if (!el.checkValidity()) {
      valid = false;
      el.style.borderColor = '#dc2626';
      if (!firstProblem) firstProblem = el;
    }
  });

  // For step 3: require at least one selection or "other" per domain
  if (stepNumber === 3){
    const groups = [
      {groupId: 'motivation_group', name: 'motivation', otherId: 'motivation_other'},
      {groupId: 'capability_group', name: 'capability', otherId: 'capability_other'},
      {groupId: 'impact_group', name: 'impact', otherId: 'impact_other'},
      {groupId: 'priority_group', name: 'priority', otherId: 'priority_other'},
      {groupId: 'viability_group', name: 'viability', otherId: 'viability_other'}
    ];

    groups.forEach(g => {
      const groupEl = document.getElementById(g.groupId);
      if (!groupEl) return;
      groupEl.style.border = 'none';
      groupEl.style.padding = '0';

      const checked = document.querySelectorAll(`input[name="${g.name}"]:checked`).length;
      const otherVal = (document.getElementById(g.otherId)?.value || "").trim();
      const groupValid = (checked > 0 || otherVal.length > 0);

      if (!groupValid){
        valid = false;
        groupEl.style.border = '1px solid #dc2626';
        groupEl.style.borderRadius = '6px';
        groupEl.style.padding = '8px';
        if (!firstProblem) firstProblem = groupEl;
      }
    });
  }

  if (!valid && firstProblem){
    if (firstProblem.scrollIntoView){
      firstProblem.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    if (firstProblem.focus){
      firstProblem.focus();
    }
  }

  return valid;
}

/* Full-form validation (for final submit) */
function validateForm(){
  const form = document.getElementById('endorsement-form');
  if (!form) return true;

  const fields = form.querySelectorAll('input, select, textarea');
  fields.forEach(el => { el.style.borderColor = '#d1d5db'; });

  ['motivation_group','capability_group','impact_group','priority_group','viability_group']
    .forEach(id => {
      const g = document.getElementById(id);
      if (g){
        g.style.border = 'none';
        g.style.padding = '0';
      }
    });

  let formValid = true;
  let firstInvalidElement = null;

  const required = form.querySelectorAll('[required]');
  required.forEach(el => {
    if (!el.checkValidity()){
      formValid = false;
      el.style.borderColor = '#dc2626';
      if (!firstInvalidElement) firstInvalidElement = el;
    }
  });

  const groups = [
    {groupId: 'motivation_group', name: 'motivation', otherId: 'motivation_other'},
    {groupId: 'capability_group', name: 'capability', otherId: 'capability_other'},
    {groupId: 'impact_group', name: 'impact', otherId: 'impact_other'},
    {groupId: 'priority_group', name: 'priority', otherId: 'priority_other'},
    {groupId: 'viability_group', name: 'viability', otherId: 'viability_other'}
  ];

  groups.forEach(g => {
    const groupEl = document.getElementById(g.groupId);
    if (!groupEl) return;

    const checked = form.querySelectorAll(`input[name="${g.name}"]:checked`).length;
    const otherVal = (document.getElementById(g.otherId)?.value || "").trim();
    const groupValid = (checked > 0 || otherVal.length > 0);

    if (!groupValid){
      formValid = false;
      groupEl.style.border = '1px solid #dc2626';
      groupEl.style.borderRadius = '6px';
      groupEl.style.padding = '8px';
      if (!firstInvalidElement) firstInvalidElement = groupEl;
    }
  });

  // Signature validation
  if (sigPad && sigPad.isEmpty()){
    formValid = false;
    alert("Please provide your signature before submitting.");
  }

  if (!formValid && firstInvalidElement){
    const stepEl = firstInvalidElement.closest('.form-step');
    if (stepEl && stepEl.dataset.step){
      showStep(stepEl.dataset.step);
    }
    if (firstInvalidElement.scrollIntoView){
      firstInvalidElement.scrollIntoView({ behavior:'smooth', block:'center' });
    }
    if (firstInvalidElement.focus){
      firstInvalidElement.focus();
    }
    return false;
  }

  return true;
}

/* Skeleton letter: up to Re: line only */
function buildSkeletonLetterHTML(data){
  const {
    refName,
    refRole,
    refRoleOther,
    org,
    email,
    phone,
    dateLine,
    hospitalName,
    hospitalAddr1,
    hospitalAddr2,
    hospitalCity,
    hospitalPostcode,
    useHeader
  } = data;

  const effectiveRole = (refRole === "Other" && refRoleOther) ? refRoleOther : refRole;

  const dateStr = dateLine ? toUKLong(dateLine) : todayUK();
  const hospital = hospitalName || "";
  const { main: trustMain, sub: trustSub } = splitTrust(org || "");

  const addressHTML = (hospitalAddr1 || hospitalAddr2 || hospitalCity || hospitalPostcode)
    ? `
      <div class="trust-address">
        ${hospitalAddr1 ? hospitalAddr1 + "<br/>" : ""}
        ${hospitalAddr2 ? hospitalAddr2 + "<br/>" : ""}
        ${
          (hospitalCity || hospitalPostcode)
            ? `${hospitalCity || ""}${hospitalCity && hospitalPostcode ? ", " : ""}${hospitalPostcode || ""}`
            : ""
        }
      </div>
    `
    : "";

  const headerHTML = useHeader ? `
    <div class="header-block">
      <div class="trust-header">
        <img src="nhs-logo.png" alt="NHS logo" class="nhs-logo-img"/>
        ${trustMain ? `<div class="trust-name">${trustMain}</div>` : ""}
        ${trustSub  ? `<div class="trust-sub">${trustSub}</div>` : ""}
        ${hospital ? `<div class="trust-hospital">${hospital}</div>` : ""}
        ${addressHTML}
      </div>
    </div>
  ` : "";

  const senderHTML = `
    <div class="sender-block">
      <div>${refName || "[Referee Name]"}</div>
      <div>${effectiveRole || "[Role]"}</div>
      ${phone ? `<div>Tel: ${phone}</div>` : ""}
      ${email ? `<div>Email: ${email}</div>` : ""}
    </div>
  `;

  const recipientHTML = `
    <div class="recipient-block">
      <div>NHS Clinical Entrepreneur Team</div>
      <div>c/o Anglia Ruskin University</div>
      <div>Bishop Hall Lane</div>
      <div>Chelmsford</div>
      <div>Essex</div>
      <div>CM1 1SQ</div>
    </div>
    <div class="recipient-subject">
      Re: Letter of Support for Alex Monterubio – NHS Clinical Entrepreneur Programme Application
    </div>
  `;

  return `
    <div class="paper" id="paper">
      <div class="page">
        <div class="header-row">
          ${senderHTML}
          ${headerHTML}
        </div>
        <div class="letter-date">Date: ${dateStr}</div>
        ${recipientHTML}
        <div style="font-family: Arial, sans-serif; font-size: 10pt; color:#9ca3af; margin-top:16px;">
          The body of your letter will appear here once you start answering the endorsement questions.
        </div>
      </div>
    </div>
  `;
}

function buildLetterHTML(data, signatureDataURL){
  const {
    refName,
    refRole,
    refRoleOther,
    org,
    email,
    phone,
    professionalArea,
    relationship,
    otherRelationshipCapacity,
    customLetterText,
    dateLine,
    hospitalName,
    hospitalAddr1,
    hospitalAddr2,
    hospitalCity,
    hospitalPostcode,
    useHeader,
    qDurationSelect,
    qDurationDetail,
    motivationSelected,
    motivationOther,
    capabilitySelected,
    capabilityOther,
    impactSelected,
    impactOther,
    prioritySelected,
    priorityOther,
    viabilitySelected,
    viabilityOther,
    letterMode,
    customOpening,
    customMotivation,
    customCapability,
    customImpact,
    customPriority,
    customViability
  } = data;

  const effectiveRole = (refRole === "Other" && refRoleOther) ? refRoleOther : refRole;

  const opening = openingsByRole[effectiveRole] ||
    "I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.";

  const dateStr = dateLine ? toUKLong(dateLine) : todayUK();

  const hospital = hospitalName || "";
  const { main: trustMain, sub: trustSub } = splitTrust(org || "");

  const addressHTML = (hospitalAddr1 || hospitalAddr2 || hospitalCity || hospitalPostcode)
    ? `
      <div class="trust-address">
        ${hospitalAddr1 ? hospitalAddr1 + "<br/>" : ""}
        ${hospitalAddr2 ? hospitalAddr2 + "<br/>" : ""}
        ${
          (hospitalCity || hospitalPostcode)
            ? `${hospitalCity || ""}${hospitalCity && hospitalPostcode ? ", " : ""}${hospitalPostcode || ""}`
            : ""
        }
      </div>
    `
    : "";

  const headerHTML = useHeader ? `
    <div class="header-block">
      <div class="trust-header">
        <img src="nhs-logo.png" alt="NHS logo" class="nhs-logo-img"/>
        ${trustMain ? `<div class="trust-name">${trustMain}</div>` : ""}
        ${trustSub  ? `<div class="trust-sub">${trustSub}</div>` : ""}
        ${hospital ? `<div class="trust-hospital">${hospital}</div>` : ""}
        ${addressHTML}
      </div>
    </div>
  ` : "";

  const senderHTML = `
    <div class="sender-block">
      <div>${refName || "[Referee Name]"}</div>
      <div>${effectiveRole || "[Role]"}</div>
      ${phone ? `<div>Tel: ${phone}</div>` : ""}
      ${email ? `<div>Email: ${email}</div>` : ""}
    </div>
  `;

  const recipientHTML = `
    <div class="recipient-block">
      <div>NHS Clinical Entrepreneur Team</div>
      <div>c/o Anglia Ruskin University</div>
      <div>Bishop Hall Lane</div>
      <div>Chelmsford</div>
      <div>Essex</div>
      <div>CM1 1SQ</div>
    </div>
    <div class="recipient-subject">
      Re: Letter of Support for Alex Monterubio – NHS Clinical Entrepreneur Programme Application
    </div>
  `;

  const salutationHTML = `<p class="sal">Dear NHS Clinical Entrepreneur Team,</p>`;

  // If different professional area, show custom letter
  if (professionalArea === 'different'){
    const sigHTML = signatureDataURL
      ? `<div class="letter-sign"><img src="${signatureDataURL}" alt="Signature"/></div>`
      : "";

    const customMessageHTML = customLetterText
      ? customLetterText
          .split('\n\n')
          .map(p => p.trim() ? `<p>${p.trim()}</p>` : '')
          .join('')
      : `<p style="color:#9ca3af; font-style:italic;">Your custom message will appear here once you complete your letter.</p>`;

    return `
      <div class="paper" id="paper">
        <div class="page">
          <div class="header-row">
            ${senderHTML}
            ${headerHTML}
          </div>
          <div class="letter-date">Date: ${dateStr}</div>
          ${recipientHTML}
          <div class="letter-body">
            ${salutationHTML}
            ${customMessageHTML}
            <div class="letter-closing">
              <p>Yours faithfully,</p>
              ${sigHTML}
              <div class="letter-signoff">
                <div class="name">${refName || "[Name]"}</div>
                <div>${effectiveRole || "[Role]"}</div>
                <div>${org || "Barts Health NHS Trust"}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Custom writing mode: Use free-text responses
  if (letterMode === 'custom') {
    const customNarrativeParts = [];

    // Opening paragraph (referee writes their own intro)
    if (customOpening && customOpening.trim()) {
      customNarrativeParts.push(`<p>${customOpening.trim()}</p>`);
    }

    // 1. Personal Motivation
    if (customMotivation && customMotivation.trim()) {
      customNarrativeParts.push(`<p>${customMotivation.trim()}</p>`);
    }

    // 2. Personal Capability
    if (customCapability && customCapability.trim()) {
      customNarrativeParts.push(`<p>${customCapability.trim()}</p>`);
    }

    // 3. Clinical Impact
    if (customImpact && customImpact.trim()) {
      customNarrativeParts.push(`<p>${customImpact.trim()}</p>`);
    }

    // 4. Priority to the NHS
    if (customPriority && customPriority.trim()) {
      customNarrativeParts.push(`<p>${customPriority.trim()}</p>`);
    }

    // 5. Viability of the Innovation
    if (customViability && customViability.trim()) {
      customNarrativeParts.push(`<p>${customViability.trim()}</p>`);
    }

    // MBA / suitability paragraph (always included)
    customNarrativeParts.push(
      `<p>Alex is currently undertaking an Executive MBA with a focus on Artificial Intelligence, further developing their leadership, strategic and innovation skills. These qualities, combined with the above, align closely with the objectives of the NHS Clinical Entrepreneur Programme, and I consider Alex well suited to contribute positively to innovation within the NHS.</p>`
    );

    // Disclaimer (always included)
    customNarrativeParts.push(
      `<p>This letter is provided as a professional endorsement of Alex Monterubio's suitability for the NHS Clinical Entrepreneur Programme. It does not imply financial sponsorship.</p>`
    );

    const sigHTML = signatureDataURL
      ? `<div class="letter-sign"><img src="${signatureDataURL}" alt="Signature"/></div>`
      : "";

    const customBodyHTML = customNarrativeParts.join("");

    return `
      <div class="paper" id="paper">
        <div class="page">
          <div class="header-row">
            ${senderHTML}
            ${headerHTML}
          </div>
          <div class="letter-date">Date: ${dateStr}</div>
          ${recipientHTML}
          <div class="letter-body">
            ${salutationHTML}
            ${customBodyHTML}
            <div class="letter-closing">
              <p>Yours faithfully,</p>
              ${sigHTML}
              <div class="letter-signoff">
                <div class="name">${refName || "[Name]"}</div>
                <div>${effectiveRole || "[Role]"}</div>
                <div>${org || "Barts Health NHS Trust"}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Otherwise, perioperative template with 5 domains
  const narrativeParts = [];

  // Duration phrase
  let durationPhrase = "";
  if (qDurationSelect){
    if (qDurationSelect === "other" && qDurationDetail){
      durationPhrase = qDurationDetail;
    } else {
      switch (qDurationSelect){
        case "less than six months":
          durationPhrase = "";
          break;
        case "between six and twelve months":
          durationPhrase = "the past six to twelve months";
          break;
        case "between one and three years":
          durationPhrase = "the past one to three years";
          break;
        case "more than three years":
          durationPhrase = "a period of more than three years";
          break;
        default:
          durationPhrase = qDurationSelect;
      }
      if (qDurationDetail && qDurationSelect !== "less than six months"){
        durationPhrase += ` (${qDurationDetail})`;
      }
    }
  }

  let capacityText = "";
  if (professionalArea === 'perioperative' && relationship){
    capacityText = relationship;
  } else if (professionalArea === 'different' && otherRelationshipCapacity){
    capacityText = otherRelationshipCapacity;
  }

  let relationshipSentence = "";
  if (qDurationSelect || capacityText){
    if (qDurationSelect === "less than six months") {
      relationshipSentence = "Although my time working with Alex has been relatively short";
    } else {
      relationshipSentence = "Over ";
      relationshipSentence += durationPhrase ? durationPhrase : "the time that Alex worked within our service";
    }

    relationshipSentence += ", I have known Alex";

    if (capacityText){
      relationshipSentence += ` in my capacity as ${capacityText.toLowerCase()}`;
    }

    relationshipSentence += ", and have been able to observe their practice in a busy perioperative environment.";
  }

  let intro = opening;
  if (relationshipSentence){
    intro += " " + relationshipSentence;
  }
  narrativeParts.push(`<p>${intro}</p>`);

  // 1. PERSONAL MOTIVATION
  const motivationItems = [...motivationSelected];
  if (motivationOther) motivationItems.push(motivationOther);
  if (motivationItems.length){
    narrativeParts.push(
      `<p>In terms of personal motivation, Alex has demonstrated ${joinAsAcademicList(motivationItems)}.</p>`
    );
  }

  // 2. PERSONAL CAPABILITY
  const capabilityItems = [...capabilitySelected];
  if (capabilityOther) capabilityItems.push(capabilityOther);
  if (capabilityItems.length){
    narrativeParts.push(
      `<p>Regarding personal capability, Alex consistently demonstrates ${joinAsAcademicList(capabilityItems)}.</p>`
    );
  }

  // 3. CLINICAL IMPACT
  const impactItems = [...impactSelected];
  if (impactOther) impactItems.push(impactOther);
  if (impactItems.length){
    narrativeParts.push(
      `<p>In my view, Alex’s innovation work has the potential to ${joinAsAcademicList(impactItems)}.</p>`
    );
  }

  // 4. PRIORITY TO THE NHS
  const priorityItems = [...prioritySelected];
  if (priorityOther) priorityItems.push(priorityOther);
  if (priorityItems.length){
    narrativeParts.push(
      `<p>Alex’s ideas align well with wider NHS priorities, particularly in their potential to ${joinAsAcademicList(priorityItems)}.</p>`
    );
  }

  // 5. VIABILITY OF THE INNOVATION
  const viabilityItems = [...viabilitySelected];
  if (viabilityOther) viabilityItems.push(viabilityOther);
  if (viabilityItems.length){
    narrativeParts.push(
      `<p>I consider Alex’s innovation highly viable within the NHS, as it is ${joinAsAcademicList(viabilityItems)}.</p>`
    );
  }

  // MBA / suitability paragraph
  narrativeParts.push(
    `<p>Alex is currently undertaking an Executive MBA with a focus on Artificial Intelligence, further developing their leadership, strategic and innovation skills. These qualities, combined with the above, align closely with the objectives of the NHS Clinical Entrepreneur Programme, and I consider Alex well suited to contribute positively to innovation within the NHS.</p>`
  );

  narrativeParts.push(
    `<p>This letter is provided as a professional endorsement of Alex Monterubio’s suitability for the NHS Clinical Entrepreneur Programme. It does not imply financial sponsorship.</p>`
  );

  const sigHTML = signatureDataURL
    ? `<div class="letter-sign"><img src="${signatureDataURL}" alt="Signature"/></div>`
    : "";

  const bodyHTML = narrativeParts.join("");

  return `
    <div class="paper" id="paper">
      <div class="page">
        <div class="header-row">
          ${senderHTML}
          ${headerHTML}
        </div>
        <div class="letter-date">Date: ${dateStr}</div>
        ${recipientHTML}
        <div class="letter-body">
          ${salutationHTML}
          ${bodyHTML}
          <div class="letter-closing">
            <p>Yours faithfully,</p>
            ${sigHTML}
            <div class="letter-signoff">
              <div class="name">${refName || "[Name]"}</div>
              <div>${effectiveRole || "[Role]"}</div>
              <div>${org || "Barts Health NHS Trust"}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function updatePreview(){
  const data = readForm();
  const preview = document.getElementById('preview');

  const hasRefDetails =
    data.refName ||
    data.refRole ||
    data.refRoleOther ||
    data.org ||
    data.email ||
    data.phone ||
    data.hospitalName ||
    data.hospitalAddr1 ||
    data.hospitalAddr2 ||
    data.hospitalCity ||
    data.hospitalPostcode ||
    data.useHeader;

  const hasQuestionContent =
    data.customLetterText ||
    data.qDurationSelect ||
    data.qDurationDetail ||
    data.motivationSelected.length ||
    data.motivationOther ||
    data.capabilitySelected.length ||
    data.capabilityOther ||
    data.impactSelected.length ||
    data.impactOther ||
    data.prioritySelected.length ||
    data.priorityOther ||
    data.viabilitySelected.length ||
    data.viabilityOther;

  if (!hasRefDetails && !hasQuestionContent){
    preview.innerHTML = `
      <div style="font-family: Arial, sans-serif; font-size: 11pt; color:#6b7280; text-align:center; padding:40px 20px;">
        Your letter preview will appear here once you have completed the questions.
      </div>
    `;
    return;
  }

  if (hasRefDetails && !hasQuestionContent){
    preview.innerHTML = buildSkeletonLetterHTML(data);
    return;
  }

  // No signature - DocuSign handles signing electronically
  const html = buildLetterHTML(data, "");
  preview.innerHTML = html;
}

function formRef(){
  const d = new Date();
  const pad = n => String(n).padStart(2, "0");
  return `NHSCEP–${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

async function makePDF(){
  const data = readForm();
  const pdf = new jspdf.jsPDF('p', 'mm', 'a4');

  // A4 dimensions and margins
  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 20;
  const usableWidth = pageWidth - (margin * 2);

  let y = margin; // Current Y position
  const lineHeight = 5;
  const paragraphSpacing = 6;

  // Load NHS logo
  const loadImage = (src) => {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  };

  let nhsLogoDataURL = null;
  try {
    const nhsLogo = await loadImage('nhs-logo.png');
    const canvas = document.createElement('canvas');
    canvas.width = nhsLogo.width;
    canvas.height = nhsLogo.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(nhsLogo, 0, 0);
    nhsLogoDataURL = canvas.toDataURL('image/png');
  } catch (e) {
    console.warn('Could not load NHS logo:', e);
  }

  // Use Helvetica font (built into jsPDF, similar to Arial)
  // Note: Helvetica is very similar to Arial and is NHS-compliant
  const fontFamily = 'helvetica';

  // Helper function to add text with word wrap
  const addText = (text, x, fontSize = 11, fontStyle = 'normal', maxWidth = usableWidth) => {
    pdf.setFontSize(fontSize);
    pdf.setFont(fontFamily, fontStyle);
    const lines = pdf.splitTextToSize(text, maxWidth);
    lines.forEach(line => {
      if (y > pageHeight - margin) {
        pdf.addPage();
        y = margin;
      }
      pdf.text(line, x, y);
      y += lineHeight;
    });
  };

  const addSpace = (space = lineHeight) => {
    y += space;
  };

  // Reference
  const ref = formRef();

  // SENDER DETAILS (top left)
  const effectiveRole = (data.refRole === "Other" && data.refRoleOther) ? data.refRoleOther : data.refRole;
  addText(data.refName || "[Referee Name]", margin, 11, 'normal');
  addText(effectiveRole || "[Role]", margin, 11, 'normal');
  if (data.phone) addText(`Tel: ${data.phone}`, margin, 11, 'normal');
  if (data.email) addText(`Email: ${data.email}`, margin, 11, 'normal');

  addSpace(paragraphSpacing);

  // NHS HEADER (right side) - with logo
  const { main: trustMain, sub: trustSub } = splitTrust(data.org || "");
  if (trustMain) {
    const headerY = margin;
    let headerTextY = headerY;

    // Add NHS logo if available
    if (nhsLogoDataURL) {
      const logoWidth = 18; // mm
      const logoHeight = 7.5; // mm (proper NHS logo aspect ratio ~2.4:1)
      pdf.addImage(nhsLogoDataURL, 'PNG', pageWidth - margin - logoWidth, headerY, logoWidth, logoHeight);
      headerTextY = headerY + logoHeight + 6; // Position text below logo with more spacing
    }

    // Trust name
    pdf.setFontSize(14);
    pdf.setFont(fontFamily, 'bold');
    const headerText = trustMain;
    const headerWidth = pdf.getTextWidth(headerText);
    pdf.text(headerText, pageWidth - margin - headerWidth, headerTextY);

    // Trust subtitle
    if (trustSub) {
      pdf.setFontSize(11);
      pdf.setFont(fontFamily, 'normal');
      pdf.setTextColor(29, 143, 219); // Blue color
      const subWidth = pdf.getTextWidth(trustSub);
      pdf.text(trustSub, pageWidth - margin - subWidth, headerTextY + 6);
      pdf.setTextColor(0, 0, 0); // Reset to black
    }

    // Hospital name
    let currentY = headerTextY + 12;
    if (data.hospitalName) {
      pdf.setFontSize(11);
      pdf.setFont(fontFamily, 'bold');
      const hospWidth = pdf.getTextWidth(data.hospitalName);
      pdf.text(data.hospitalName, pageWidth - margin - hospWidth, currentY);
      currentY += 5;
    }

    // Hospital address
    pdf.setFontSize(10);
    pdf.setFont(fontFamily, 'normal');
    if (data.hospitalAddr1) {
      const addr1Width = pdf.getTextWidth(data.hospitalAddr1);
      pdf.text(data.hospitalAddr1, pageWidth - margin - addr1Width, currentY);
      currentY += 4;
    }
    if (data.hospitalAddr2) {
      const addr2Width = pdf.getTextWidth(data.hospitalAddr2);
      pdf.text(data.hospitalAddr2, pageWidth - margin - addr2Width, currentY);
      currentY += 4;
    }
    if (data.hospitalCity) {
      const cityWidth = pdf.getTextWidth(data.hospitalCity);
      pdf.text(data.hospitalCity, pageWidth - margin - cityWidth, currentY);
      currentY += 4;
    }
    if (data.hospitalPostcode) {
      const postcodeWidth = pdf.getTextWidth(data.hospitalPostcode);
      pdf.text(data.hospitalPostcode, pageWidth - margin - postcodeWidth, currentY);
    }
  }

  // DATE
  const dateStr = data.dateLine ? toUKLong(data.dateLine) : todayUK();
  addText(`Date: ${dateStr}`, margin, 11, 'normal');
  addSpace(paragraphSpacing);

  // RECIPIENT
  addText("NHS Clinical Entrepreneur Team", margin, 11, 'normal');
  addText("c/o Anglia Ruskin University", margin, 11, 'normal');
  addText("Bishop Hall Lane", margin, 11, 'normal');
  addText("Chelmsford", margin, 11, 'normal');
  addText("Essex", margin, 11, 'normal');
  addText("CM1 1SQ", margin, 11, 'normal');
  addSpace(paragraphSpacing);

  // SUBJECT
  pdf.setFont(fontFamily, 'bold');
  addText("Re: Letter of Support for Alex Monterubio – NHS Clinical Entrepreneur Programme Application", margin, 11, 'bold');
  pdf.setFont(fontFamily, 'normal');
  addSpace(paragraphSpacing);

  // SALUTATION
  addText("Dear NHS Clinical Entrepreneur Team,", margin, 11, 'normal');
  addSpace(paragraphSpacing);

  // BODY - Build the narrative
  const opening = openingsByRole[effectiveRole] || "I am pleased to provide a letter of support for Alex Monterubio, who previously worked as a Senior Team Leader in Theatres at the Royal London Hospital, Barts Health NHS Trust.";

  // Build relationship sentence (same logic as buildLetterHTML)
  let capacityText = "";
  if (data.professionalArea === 'perioperative' && data.relationship){
    capacityText = data.relationship;
  } else if (data.professionalArea === 'different' && data.otherRelationshipCapacity){
    capacityText = data.otherRelationshipCapacity;
  }

  let durationPhrase = "";
  if (data.qDurationSelect){
    if (data.qDurationSelect === "other" && data.qDurationDetail){
      durationPhrase = data.qDurationDetail;
    } else {
      switch (data.qDurationSelect){
        case "less than six months": break;
        case "between six and twelve months": durationPhrase = "the past six to twelve months"; break;
        case "between one and three years": durationPhrase = "the past one to three years"; break;
        case "more than three years": durationPhrase = "a period of more than three years"; break;
        default: durationPhrase = data.qDurationSelect;
      }
      if (data.qDurationDetail && data.qDurationSelect !== "less than six months"){
        durationPhrase += ` (${data.qDurationDetail})`;
      }
    }
  }

  let relationshipSentence = "";
  if (data.qDurationSelect || capacityText){
    if (data.qDurationSelect === "less than six months") {
      relationshipSentence = "Although my time working with Alex has been relatively short";
    } else {
      relationshipSentence = "Over ";
      relationshipSentence += durationPhrase ? durationPhrase : "the time that Alex worked within our service";
    }
    relationshipSentence += ", I have known Alex";
    if (capacityText){
      relationshipSentence += ` in my capacity as ${capacityText.toLowerCase()}`;
    }
    relationshipSentence += ", and have been able to observe their practice in a busy perioperative environment.";
  }

  let intro = opening;
  if (relationshipSentence){
    intro += " " + relationshipSentence;
  }

  addText(intro, margin, 11, 'normal');
  addSpace(paragraphSpacing);

  // Build narrative from 5 NHSCEP domains (template OR custom mode)
  if (data.letterMode === 'custom'){
    // Custom mode: Insert free-text answers
    if (data.customMotivation){
      addText(data.customMotivation, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }
    if (data.customCapability){
      addText(data.customCapability, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }
    if (data.customImpact){
      addText(data.customImpact, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }
    if (data.customPriority){
      addText(data.customPriority, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }
    if (data.customViability){
      addText(data.customViability, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }
  } else {
    // Template mode: Use toggle.html narrative structure

    // 1. Motivation
    const motivationItems = [...(data.motivationSelected || [])];
    if (data.motivationOther) motivationItems.push(data.motivationOther);
    if (motivationItems.length){
      const phrase = motivationItems.length === 1 ? motivationItems[0] :
                     motivationItems.length === 2 ? motivationItems.join(" and ") :
                     motivationItems.slice(0, -1).join(", ") + ", and " + motivationItems[motivationItems.length - 1];
      addText(`In terms of personal motivation, Alex has demonstrated ${phrase}.`, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }

    // 2. Capability
    const capabilityItems = [...(data.capabilitySelected || [])];
    if (data.capabilityOther) capabilityItems.push(data.capabilityOther);
    if (capabilityItems.length){
      const phrase = capabilityItems.length === 1 ? capabilityItems[0] :
                     capabilityItems.length === 2 ? capabilityItems.join(" and ") :
                     capabilityItems.slice(0, -1).join(", ") + ", and " + capabilityItems[capabilityItems.length - 1];
      addText(`Regarding personal capability, Alex consistently demonstrates ${phrase}.`, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }

    // 3. Impact
    const impactItems = [...(data.impactSelected || [])];
    if (data.impactOther) impactItems.push(data.impactOther);
    if (impactItems.length){
      const phrase = impactItems.length === 1 ? impactItems[0] :
                     impactItems.length === 2 ? impactItems.join(" and ") :
                     impactItems.slice(0, -1).join(", ") + ", and " + impactItems[impactItems.length - 1];
      addText(`In my view, Alex's innovation work has the potential to ${phrase}.`, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }

    // 4. Priority alignment
    const priorityItems = [...(data.prioritySelected || [])];
    if (data.priorityOther) priorityItems.push(data.priorityOther);
    if (priorityItems.length){
      const phrase = priorityItems.length === 1 ? priorityItems[0] :
                     priorityItems.length === 2 ? priorityItems.join(" and ") :
                     priorityItems.slice(0, -1).join(", ") + ", and " + priorityItems[priorityItems.length - 1];
      addText(`Alex's ideas align well with wider NHS priorities, particularly in their potential to ${phrase}.`, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }

    // 5. Viability
    const viabilityItems = [...(data.viabilitySelected || [])];
    if (data.viabilityOther) viabilityItems.push(data.viabilityOther);
    if (viabilityItems.length){
      const phrase = viabilityItems.length === 1 ? viabilityItems[0] :
                     viabilityItems.length === 2 ? viabilityItems.join(" and ") :
                     viabilityItems.slice(0, -1).join(", ") + ", and " + viabilityItems[viabilityItems.length - 1];
      addText(`I consider Alex's innovation highly viable within the NHS, as it is ${phrase}.`, margin, 11, 'normal');
      addSpace(paragraphSpacing);
    }
  }

  // MBA + Suitability
  const mbaSentence = "Alex is currently undertaking an Executive MBA, further developing their leadership, strategic and innovation skills, qualities that align closely with the objectives of the NHS Clinical Entrepreneur Programme.";

  let suitabilitySentence = "";
  if (data.qSuitabilitySelect || data.qSuitabilityDetail){
    const reasons = [];
    if (data.qSuitabilitySelect) reasons.push(data.qSuitabilitySelect);
    if (data.qSuitabilityDetail) reasons.push(data.qSuitabilityDetail);

    let reasonsPhrase = "";
    if (reasons.length === 1){
      reasonsPhrase = reasons[0];
    } else if (reasons.length === 2){
      reasonsPhrase = reasons.join(" and ");
    } else {
      reasonsPhrase = reasons.slice(0, -1).join(", ") + ", and " + reasons[reasons.length - 1];
    }

    suitabilitySentence = `On the basis of the above, and my experience of working with Alex, I consider them well suited to the NHS Clinical Entrepreneur Programme because of ${reasonsPhrase}.`;
  } else {
    suitabilitySentence = "On the basis of the above, and my experience of working with Alex, I consider them well suited to the NHS Clinical Entrepreneur Programme and capable of contributing positively to innovation within the NHS.";
  }

  addText(`${mbaSentence} ${suitabilitySentence}`, margin, 11, 'normal');
  addSpace(paragraphSpacing);

  // Disclaimer
  addText("This letter is provided as a professional endorsement of Alex Monterubio's suitability for the NHS Clinical Entrepreneur Programme. It does not imply financial sponsorship.", margin, 11, 'normal');
  addSpace(paragraphSpacing * 2);

  // CLOSING
  addText("Yours faithfully,", margin, 11, 'normal');
  addSpace(lineHeight);

  // SIGNATURE (if available)
  if (sigPad && !sigPad.isEmpty()){
    const sigDataURL = sigPad.toDataURL('image/jpeg', 0.7);
    pdf.addImage(sigDataURL, 'JPEG', margin, y, 40, 10);
    y += 12;  // Extra space after signature
  } else {
    y += 8;
  }

  // SIGNOFF
  addText(data.refName || "[Name]", margin, 11, 'bold');
  addText(effectiveRole || "[Role]", margin, 11, 'normal');
  addText(data.org || "Barts Health NHS Trust", margin, 11, 'normal');

  const blob = pdf.output('blob');
  const dataURI = pdf.output('datauristring');
  const filename = `Letter_of_Support_${(effectiveRole || 'Referee').replace(/\s+/g,'_')}_Alex_Monterubio.pdf`;
  return { pdfBlob: blob, pdfDataURI: dataURI, filename, ref };
}


// Call your Vercel/Resend API (optional)
async function sendToBackend(payload){
  if (!BACKEND_ENDPOINT) return;
  try{
    await fetch(BACKEND_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (e){
    console.error("Backend send failed:", e);
  }
}

function showToast(){
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 7000);
}

async function emailLetter(){
  if (!validateForm()) { return; }

  // Show loading overlay
  const loadingOverlay = document.getElementById('loading-overlay');
  if (loadingOverlay) {
    loadingOverlay.classList.add('show');
  }

  try {
    // Make sure preview (with signature) is up to date
    updatePreview();

    const data = readForm();
    const { pdfDataURI, filename, ref } = await makePDF();

    const effectiveRole = (data.refRole === "Other" && data.refRoleOther) ? data.refRoleOther : data.refRole;

    // Send to backend (Resend on Vercel)
    if (data.email){
      await sendToBackend({
        refCode: ref,
        filename,
        pdfBase64: pdfDataURI.split(',')[1],
        referee: {
          name: data.refName,
          role: effectiveRole,
          email: data.email,
          phone: data.phone
        }
      });

      // Reset form after successful email
      document.getElementById('endorsement-form').reset();
      if (sigPad){ sigPad.clear(); }
      const dateInput = document.getElementById('date_line');
      dateInput.type = 'date';
      dateInput.value = todayUKISO();
      updatePreview();

      // Hide loading overlay
      if (loadingOverlay) {
        loadingOverlay.classList.remove('show');
      }

      // Show success toast
      showToast();
    } else {
      // Hide loading overlay
      if (loadingOverlay) {
        loadingOverlay.classList.remove('show');
      }
      alert('Please provide an email address to send the letter.');
    }
  } catch (error) {
    // Hide loading overlay on error
    if (loadingOverlay) {
      loadingOverlay.classList.remove('show');
    }
    console.error('Error sending letter:', error);
    alert('An error occurred while sending the letter. Please try again.');
  }
}
function printLetter(){
  window.print();
}

function showStep(step){
  currentStep = step;

  const stepNames = ['Your details', 'Relationship', 'NHSCEP domains', 'Sign & submit'];

  // Special custom-letter step
  if (step === '2a' || step === 2.5){
    document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
    const customStep = document.getElementById('step-custom-letter');
    if (customStep) customStep.classList.add('active');

    const progress = document.querySelector('.progress-bar');
    if (progress) progress.style.width = '25%';

    const labelSpan = document.getElementById('step-counter');
    if (labelSpan) labelSpan.textContent = 'Step 2 of 3';

    const labelsContainer = document.getElementById('step-labels-container');
    if (labelsContainer){
      labelsContainer.innerHTML = `
        <span>Your details</span>
        <span class="is-active">Custom letter</span>
      `;
    }

    // Scroll to top of page and left panel
    window.scrollTo({ top: 0, behavior: 'smooth' });
    const leftPanel = document.querySelector('.panel.left');
    if (leftPanel && leftPanel.scrollTo){
      leftPanel.scrollTo({ top:0, behavior:'smooth' });
    }
    return;
  }

  document.querySelectorAll('.form-step').forEach(s => {
    const isMatch = String(s.dataset.step) === String(step);
    s.classList.toggle('active', isMatch);
  });

  const customLetterStep = document.getElementById('step-custom-letter');
  if (customLetterStep){
    if (step === 2){
      customLetterStep.classList.remove('active');
      customLetterStep.classList.add('hidden');
    }
  }

  const progress = document.querySelector('.progress-bar');
  if (progress && typeof step === 'number'){
    const pct = ((step - 1) / (totalSteps - 1)) * 100;
    progress.style.width = `${pct}%`;
  }

  const labelSpan = document.getElementById('step-counter');
  if (labelSpan && typeof step === 'number'){
    labelSpan.textContent = `Step ${step} of ${totalSteps}`;
  }

  const labelsContainer = document.getElementById('step-labels-container');
  if (labelsContainer && typeof step === 'number'){
    let html = '';
    if (step > 1){
      html += `<span>${stepNames[step - 2]}</span>`;
    }
    html += `<span class="is-active">${stepNames[step - 1]}</span>`;
    labelsContainer.innerHTML = html;
  }

  // Scroll to top of page and left panel
  window.scrollTo({ top: 0, behavior: 'smooth' });
  const leftPanel = document.querySelector('.panel.left');
  if (leftPanel && leftPanel.scrollTo){
    leftPanel.scrollTo({ top:0, behavior:'smooth' });
  }

  if (step === 4) {
    const event = new Event('resize');
    window.dispatchEvent(event);
  }
}

// For "Other Professional Relationship" path
function goToFinalStep(){
  const customText = document.getElementById('custom_letter_text');
  if (customText && !customText.value.trim()){
    customText.style.borderColor = '#dc2626';
    alert('Please write your letter of support before continuing.');
    return;
  }
  showStep(4);
}

// Step 2 Next logic: branch to custom letter if needed
function handleStep2Next(){
  const areaSelect = document.getElementById('professional_area');
  if (!validateStep(2)) return;
  const area = areaSelect ? areaSelect.value : '';
  if (area === 'different'){
    showStep('2a');
  } else {
    showStep(3);
  }
}

function handleProfessionalAreaChange(){
  const areaSelect = document.getElementById('professional_area');
  const perioperativeCapacityWrap = document.getElementById('perioperative_capacity_wrap');
  const otherCapacityWrap = document.getElementById('other_capacity_wrap');
  const relationshipSelect = document.getElementById('relationship');
  const otherRelationshipInput = document.getElementById('other_relationship_capacity');
  const durationLabel = document.getElementById('duration_label');

  if (!areaSelect) return;

  const area = areaSelect.value;

  if (area === 'different'){
    if (perioperativeCapacityWrap) perioperativeCapacityWrap.classList.add('hidden');
    if (otherCapacityWrap) otherCapacityWrap.classList.remove('hidden');
    if (relationshipSelect) relationshipSelect.removeAttribute('required');
    if (otherRelationshipInput) otherRelationshipInput.setAttribute('required', 'required');
    if (durationLabel) durationLabel.textContent = 'How long have you known Alex in this professional capacity?';
  } else if (area === 'perioperative'){
    if (perioperativeCapacityWrap) perioperativeCapacityWrap.classList.remove('hidden');
    if (otherCapacityWrap) otherCapacityWrap.classList.add('hidden');
    if (relationshipSelect) relationshipSelect.setAttribute('required', 'required');
    if (otherRelationshipInput) otherRelationshipInput.removeAttribute('required');
    if (durationLabel) durationLabel.textContent = 'How long have you worked with Alex in perioperative/theatre services?';
  } else {
    if (perioperativeCapacityWrap) perioperativeCapacityWrap.classList.add('hidden');
    if (otherCapacityWrap) otherCapacityWrap.classList.add('hidden');
    if (relationshipSelect) relationshipSelect.removeAttribute('required');
    if (otherRelationshipInput) otherRelationshipInput.removeAttribute('required');
  }

  updatePreview();
}

// Checkbox limit helper (max 3 per domain)
function setupCheckboxLimit(name, max){
  const boxes = Array.from(document.querySelectorAll(`input[name="${name}"]`));
  if (!boxes.length) return;

  function update(){
    const checked = boxes.filter(b => b.checked);
    const limitReached = checked.length >= max;

    boxes.forEach(b => {
      const label = b.closest('.inline-option');
      if (!b.checked){
        b.disabled = limitReached;
        if (label){
          label.classList.toggle('disabled-option', limitReached);
        }
      } else {
        b.disabled = false;
        if (label){
          label.classList.remove('disabled-option');
        }
      }
    });
  }

  boxes.forEach(b => b.addEventListener('change', update));
  update();
}

function toggleOptionalField(wrapId){
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  if (wrap.classList.contains('hidden')){
    wrap.classList.remove('hidden');
  } else {
    wrap.classList.add('hidden');
    const textarea = wrap.querySelector('textarea');
    if (textarea) textarea.value = '';
  }
  updatePreview();
}

function toggleDurationDetail(){
  const select = document.getElementById('q_duration_select');
  const detailWrap = document.getElementById('duration_detail_wrap');
  if (!select || !detailWrap) return;

  if (select.value === 'other'){
    detailWrap.classList.remove('hidden');
  } else {
    detailWrap.classList.add('hidden');
    const detailInput = document.getElementById('q_duration_detail');
    if (detailInput) detailInput.value = '';
  }
  updatePreview();
}

// Toggle between custom and template letter modes
function toggleLetterMode() {
  const customMode = document.getElementById('custom-mode');
  const templateMode = document.getElementById('template-mode');
  const selectedMode = document.querySelector('input[name="letter_mode"]:checked').value;

  if (selectedMode === 'custom') {
    // Show custom mode, hide template
    customMode.classList.remove('hidden');
    templateMode.classList.add('hidden');

    // Clear template mode selections
    document.querySelectorAll('input[name="motivation"]:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="capability"]:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="impact"]:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="priority"]:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="viability"]:checked').forEach(cb => cb.checked = false);
    document.getElementById('motivation_other').value = '';
    document.getElementById('capability_other').value = '';
    document.getElementById('impact_other').value = '';
    document.getElementById('priority_other').value = '';
    document.getElementById('viability_other').value = '';
  } else {
    // Show template mode, hide custom
    customMode.classList.add('hidden');
    templateMode.classList.remove('hidden');

    // Clear custom mode text areas
    document.getElementById('custom_opening').value = '';
    document.getElementById('custom_motivation').value = '';
    document.getElementById('custom_capability').value = '';
    document.getElementById('custom_impact').value = '';
    document.getElementById('custom_priority').value = '';
    document.getElementById('custom_viability').value = '';
  }
  updatePreview();
}

// Smart Hospital/Trust Linking
let hospitalsData = [];

async function loadHospitalData() {
  try {
    const response = await fetch('london_hospitals.json');
    hospitalsData = await response.json();
    populateTrustList();
  } catch (e) {
    console.warn('Could not load hospital data:', e);
  }
}

function populateTrustList() {
  const trustList = document.getElementById('trust-list');
  if (!trustList) return;
  const uniqueTrusts = [...new Set(hospitalsData.map(h => h.trust))].sort();
  trustList.innerHTML = uniqueTrusts.map(trust => `<option value="${trust}">`).join('');
}

function populateHospitalList(trustName) {
  const hospitalList = document.getElementById('hospital-list');
  if (!hospitalList) return;
  const matchingHospitals = hospitalsData.filter(h => h.trust === trustName);
  hospitalList.innerHTML = matchingHospitals.map(h => `<option value="${h.hospital}">`).join('');
}

function getHospitalByName(hospitalName) {
  return hospitalsData.find(h => h.hospital === hospitalName);
}

function getHospitalsByTrust(trustName) {
  return hospitalsData.filter(h => h.trust === trustName);
}

function clearHospitalFields() {
  document.getElementById('hospital_name').value = '';
  clearAddressFields();
}

function clearAddressFields() {
  document.getElementById('hospital_addr1').value = '';
  document.getElementById('hospital_addr2').value = '';
  document.getElementById('hospital_city').value = '';
  document.getElementById('hospital_postcode').value = '';
}

function fillHospitalData(hospital) {
  const orgInput = document.getElementById('org');
  const hospitalInput = document.getElementById('hospital_name');

  if (orgInput && orgInput.value !== hospital.trust) {
    orgInput.value = hospital.trust;
    toggleClearButton('org-wrapper', hospital.trust);
  }
  if (hospitalInput && hospitalInput.value !== hospital.hospital) {
    hospitalInput.value = hospital.hospital;
    toggleClearButton('hospital-wrapper', hospital.hospital);
  }

  const addressParts = hospital.address.split(',').map(s => s.trim());
  document.getElementById('hospital_addr1').value = addressParts[0] || '';
  document.getElementById('hospital_addr2').value = addressParts[1] || '';
  document.getElementById('hospital_city').value = addressParts[2] || hospital.address.split(',').pop().trim();
  document.getElementById('hospital_postcode').value = hospital.postcode || '';
}

function setupHospitalLinking() {
  const orgInput = document.getElementById('org');
  const hospitalInput = document.getElementById('hospital_name');
  if (!orgInput || !hospitalInput) return;

  orgInput.addEventListener('input', function() {
    const trustName = this.value.trim();
    toggleClearButton('org-wrapper', trustName);
    if (!trustName) {
      clearHospitalFields();
      document.getElementById('hospital-list').innerHTML = '';
    } else {
      populateHospitalList(trustName);
      const hospitals = getHospitalsByTrust(trustName);
      if (hospitals.length === 1) {
        fillHospitalData(hospitals[0]);
      }
    }
    updatePreview();
  });

  hospitalInput.addEventListener('input', function() {
    const hospitalName = this.value.trim();
    toggleClearButton('hospital-wrapper', hospitalName);
    if (!hospitalName) {
      clearAddressFields();
    } else {
      const hospital = getHospitalByName(hospitalName);
      if (hospital) {
        fillHospitalData(hospital);
      }
    }
    updatePreview();
  });
}

// Clear button functions
function toggleClearButton(wrapperId, value) {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return;
  if (value && value.length > 0) {
    wrapper.classList.add('has-value');
  } else {
    wrapper.classList.remove('has-value');
  }
}

function clearOrgField() {
  const orgInput = document.getElementById('org');
  orgInput.value = '';
  toggleClearButton('org-wrapper', '');
  clearHospitalFields();
  document.getElementById('hospital-list').innerHTML = '';
  updatePreview();
}

function clearHospitalField() {
  const hospitalInput = document.getElementById('hospital_name');
  hospitalInput.value = '';
  toggleClearButton('hospital-wrapper', '');
  clearAddressFields();
  updatePreview();
}

window.addEventListener('DOMContentLoaded', () => {
  // Signature canvas
  const canvas = document.getElementById('signature-canvas');
  const ctx = canvas.getContext('2d');

  function resizeSignatureCanvas(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvas.getBoundingClientRect();
    if (!rect.width || !rect.height) return;
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx.lineWidth = 3.5;  // Thicker like a pen signature
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000000';
  }

  sigPad = {
    _empty: true,
    clear(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      this._empty = true;
      const watermark = document.getElementById('sig-watermark');
      if (watermark) watermark.style.display = 'flex';
    },
    isEmpty(){
      return this._empty;
    },
    toDataURL(){
      return canvas.toDataURL('image/png');
    }
  };

  let drawing = false;
  let lastX = 0;
  let lastY = 0;

  function getPos(evt){
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  }

  function startDraw(evt){
    evt.preventDefault();
    resizeSignatureCanvas();
    const pos = getPos(evt);
    drawing = true;
    lastX = pos.x;
    lastY = pos.y;
    sigPad._empty = false;
    const watermark = document.getElementById('sig-watermark');
    if (watermark) watermark.style.display = 'none';
  }

  function draw(evt){
    if (!drawing) return;
    evt.preventDefault();
    const pos = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }

  function endDraw(evt){
    if (!drawing) return;
    evt.preventDefault();
    drawing = false;
    updatePreview();
  }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', endDraw);
  canvas.addEventListener('mouseleave', endDraw);

  canvas.addEventListener('touchstart', startDraw, { passive:false });
  canvas.addEventListener('touchmove', draw, { passive:false });
  canvas.addEventListener('touchend', endDraw, { passive:false });
  canvas.addEventListener('touchcancel', endDraw, { passive:false });

  const clearBtn = document.getElementById('clear-signature-btn');
  if (clearBtn){
    clearBtn.addEventListener('click', () => {
      sigPad.clear();
      updatePreview();
    });
  }

  // Date default
  const dateInput = document.getElementById('date_line');
  if (dateInput){
    dateInput.type = 'date';
    if (!dateInput.value){ dateInput.value = todayUKISO(); }
  }

  document.getElementById('endorsement-form').addEventListener('input', () => {
    updatePreview();
  });

  // Step navigation (except step 2 which has its own handler)
  document.querySelectorAll('[data-next-step]').forEach(btn => {
    const target = btn.dataset.nextStep;
    if (target === '3' && btn.id === 'step2-next-button') return; // handled separately
    btn.addEventListener('click', () => {
      const currentStepEl = btn.closest('.form-step');
      const currentStepNum = currentStepEl ? parseInt(currentStepEl.dataset.step, 10) : 1;
      if (!validateStep(currentStepNum)) return;
      const t = target === '2a' ? '2a' : parseInt(target,10);
      showStep(t);
    });
  });

  document.querySelectorAll('[data-prev-step]').forEach(btn => {
    btn.addEventListener('click', () => {
      const step = parseInt(btn.dataset.prevStep,10);
      showStep(step);
    });
  });

  // Professional area change handler
  const professionalAreaSelect = document.getElementById('professional_area');
  if (professionalAreaSelect){
    professionalAreaSelect.addEventListener('change', handleProfessionalAreaChange);
    handleProfessionalAreaChange();
  }

  // Populate trust datalist with unique trusts
  const trustDatalist = document.getElementById('trust-list');
  if (trustDatalist){
    const uniqueTrusts = [...new Set(hospitalDirectory.map(h => h.trust))].sort();
    uniqueTrusts.forEach(trust => {
      const option = document.createElement('option');
      option.value = trust;
      trustDatalist.appendChild(option);
    });
  }

  // Hospital datalist
  const hospitalDatalist = document.getElementById('hospital-list');
  function updateHospitalList(filterTrust = null){
    if (!hospitalDatalist) return;
    hospitalDatalist.innerHTML = '';

    let hospitals = hospitalDirectory;
    if (filterTrust){
      hospitals = hospitals.filter(h => h.trust === filterTrust);
    }

    hospitals.forEach(h => {
      const option = document.createElement('option');
      option.value = h.hospital;
      option.setAttribute('data-trust', h.trust);
      hospitalDatalist.appendChild(option);
    });
  }
  updateHospitalList();

  const hospitalInput = document.getElementById('hospital_name');
  if (hospitalInput){
    const handleHospitalLookup = () => {
      const name = hospitalInput.value.trim();
      if (!name || name.length < 3) return;

      const match = findHospitalMatch(name);
      if (!match){
        updatePreview();
        return;
      }

      hospitalInput.value = match.hospital;

      const orgInput = document.getElementById('org');
      if (orgInput){
        orgInput.value = match.trust;
        updateHospitalList(match.trust);
        const hospitalLabel = document.querySelector('label[for="hospital_name"]');
        if (hospitalLabel){
          const filteredCount = hospitalDirectory.filter(h => h.trust === match.trust).length;
          hospitalLabel.innerHTML = `Hospital name <span style="color:#0891b2; font-size:10pt;">(${filteredCount} hospital${filteredCount !== 1 ? 's' : ''} in this trust)</span>`;
        }
      }

      const addressParts = parseAddress(match.address);
      const addr1 = document.getElementById('hospital_addr1');
      const addr2 = document.getElementById('hospital_addr2');
      const city  = document.getElementById('hospital_city');
      const pc    = document.getElementById('hospital_postcode');

      if (addr1) addr1.value = addressParts.line1;
      if (addr2) addr2.value = addressParts.line2;
      if (city)  city.value  = addressParts.city;
      if (pc)    pc.value    = match.postcode;

      updatePreview();
    };

    hospitalInput.addEventListener('blur', handleHospitalLookup);
    hospitalInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        handleHospitalLookup();
      }
    });
  }

  const orgInput = document.getElementById('org');
  if (orgInput){
    orgInput.addEventListener('input', () => {
      const selectedTrust = orgInput.value.trim();
      const trustExists = hospitalDirectory.some(h => h.trust === selectedTrust);
      if (trustExists){
        updateHospitalList(selectedTrust);
        const hospitalLabel = document.querySelector('label[for="hospital_name"]');
        if (hospitalLabel){
          const filteredCount = hospitalDirectory.filter(h => h.trust === selectedTrust).length;
          hospitalLabel.innerHTML = `Hospital name <span style="color:#0891b2; font-size:10pt;">(${filteredCount} hospital${filteredCount !== 1 ? 's' : ''} in this trust)</span>`;
        }
      } else {
        updateHospitalList();
        const hospitalLabel = document.querySelector('label[for="hospital_name"]');
        if (hospitalLabel){
          hospitalLabel.textContent = 'Hospital name';
        }
      }
    });

    const handleOrgLookup = () => {
      const orgName = orgInput.value.trim();
      if (!orgName || orgName.length < 3) return;

      const match = findTrustMatch(orgName);
      if (!match){
        updatePreview();
        return;
      }

      orgInput.value = match.trust;
      updateHospitalList(match.trust);

      const hospitalLabel = document.querySelector('label[for="hospital_name"]');
      if (hospitalLabel){
        const filteredCount = hospitalDirectory.filter(h => h.trust === match.trust).length;
        hospitalLabel.innerHTML = `Hospital name <span style="color:#0891b2; font-size:10pt;">(${filteredCount} hospital${filteredCount !== 1 ? 's' : ''} in this trust)</span>`;
      }

      if (hospitalInput){
        if (!hospitalInput.value.trim()){
          setTimeout(() => hospitalInput.focus(), 100);
        } else {
          const currentHospital = findHospitalMatch(hospitalInput.value);
          if (currentHospital && currentHospital.trust !== match.trust){
            hospitalInput.value = '';
            setTimeout(() => hospitalInput.focus(), 100);
          }
        }
      }

      updatePreview();
    };

    orgInput.addEventListener('blur', handleOrgLookup);
    orgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        handleOrgLookup();
      }
    });
  }

  const postcodeInput = document.getElementById('hospital_postcode');
  if (postcodeInput){
    const handlePostcodeLookup = () => {
      const pc = postcodeInput.value.trim().toUpperCase();
      if (!pc || pc.length < 5) return;

      const match = hospitalDirectory.find(h =>
        h.postcode.toUpperCase().replace(/\s/g, '') === pc.replace(/\s/g, '')
      );

      if (!match){
        updatePreview();
        return;
      }

      if (hospitalInput) hospitalInput.value = match.hospital;

      const orgInput = document.getElementById('org');
      if (orgInput && !orgInput.value.trim()){
        orgInput.value = match.trust;
      }

      const addressParts = parseAddress(match.address);
      const addr1 = document.getElementById('hospital_addr1');
      const addr2 = document.getElementById('hospital_addr2');
      const city  = document.getElementById('hospital_city');

      if (addr1) addr1.value = addressParts.line1;
      if (addr2) addr2.value = addressParts.line2;
      if (city)  city.value  = addressParts.city;
      postcodeInput.value = match.postcode;

      updatePreview();
    };

    postcodeInput.addEventListener('blur', handlePostcodeLookup);
    postcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        handlePostcodeLookup();
      }
    });
  }

  // Role "Other" toggle
  const refRoleSelect = document.getElementById('ref_role');
  const refRoleOtherWrap = document.getElementById('ref_role_other_wrap');
  if (refRoleSelect && refRoleOtherWrap){
    const onRoleChange = () => {
      if (refRoleSelect.value === "Other"){
        refRoleOtherWrap.classList.remove('hidden');
      } else {
        refRoleOtherWrap.classList.add('hidden');
        const input = document.getElementById('ref_role_other');
        if (input) input.value = "";
      }
      updatePreview();
    };
    refRoleSelect.addEventListener('change', onRoleChange);
    onRoleChange();
  }

  // Limit 3 selections per NHSCEP domain
  setupCheckboxLimit('motivation', 3);
  setupCheckboxLimit('capability', 3);
  setupCheckboxLimit('impact', 3);
  setupCheckboxLimit('priority', 3);
  setupCheckboxLimit('viability', 3);

  // Load hospital data and setup smart linking
  loadHospitalData();
  setupHospitalLinking();

  showStep(1);
  updatePreview();
});
</script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Digital Professional Endorsement</h1>
      <p>NHS Clinical Entrepreneur Programme – Candidate: Alex Monterubio</p>
    </header>
    <main>
      <!-- LEFT: WIZARD FORM -->
      <div class="panel left">
        <div class="note">
          <strong>About this form:</strong> This endorsement supports Alex Monterubio's application to the NHS Clinical Entrepreneur Programme
          (see <a href="https://www.nhscep.com" target="_blank" rel="noopener">www.nhscep.com</a>).
          The generated PDF is a professional endorsement only and <strong>does not imply financial sponsorship</strong>.
          <br/><br/>
          <strong>No data is stored by this tool – your details are used only to generate this one-off PDF and the confirmation emails.</strong>
        </div>

        <div class="steps-nav">
          <div class="steps-nav-left">
            <span id="step-counter">Step 1 of 4</span>
          </div>
          <div class="steps-nav-right">
            <div class="progress-track">
              <div class="progress-bar"></div>
            </div>
            <div class="step-labels" id="step-labels-container">
              <span class="is-active">Your details</span>
            </div>
          </div>
        </div>

        <form id="endorsement-form" onsubmit="event.preventDefault();">
          <!-- STEP 1 -->
          <div class="form-step active" data-step="1">
            <div class="section-title">Your Information</div>
            <div class="grid">
              <div class="col-2">
                <label for="ref_name">Your full name</label>
                <input id="ref_name" name="ref_name" required/>
              </div>

              <div class="col-2">
                <label for="ref_role">Your job title/role</label>
                <select id="ref_role" name="ref_role" required>
                  <option value="">Please select...</option>
                  <optgroup label="Professional / Nursing Leadership">
                    <option>Head of Nursing</option>
                    <option>Associate Director of Nursing</option>
                    <option>Matron</option>
                    <option>Deputy Matron</option>
                    <option>Practice Development Nurse</option>
                    <option>Senior Team Leader</option>
                    <option>Associate Team Leader</option>
                  </optgroup>
                  <optgroup label="Divisional / Senior Management">
                    <option>Divisional Operations Director</option>
                    <option>Divisional Nurse Director</option>
                    <option>Divisional/Clinical Director</option>
                    <option>Divisional General Manager</option>
                  </optgroup>
                  <optgroup label="Service Management">
                    <option>General Manager</option>
                    <option>Deputy General Manager</option>
                    <option>Service Manager</option>
                    <option>Service Delivery Manager</option>
                    <option>Associate Service Manager</option>
                  </optgroup>
                  <optgroup label="Operational Management">
                    <option>Head of Perioperative Services</option>
                    <option>Perioperative Services Manager</option>
                    <option>Operations Manager</option>
                    <option>Deputy Operations Manager</option>
                    <option>Site Manager</option>
                  </optgroup>
                  <optgroup label="Medical Staff">
                    <option>Consultant Surgeon</option>
                    <option>Consultant Anaesthetist</option>
                    <option>Senior Registrar</option>
                    <option>Surgical Fellow</option>
                    <option>Anaesthetic Fellow</option>
                    <option>Specialty Doctor / SAS Doctor</option>
                  </optgroup>
                  <optgroup label="Executive Leadership">
                    <option>Chief Executive Officer</option>
                    <option>Chief Operating Officer (COO)</option>
                    <option>Medical Director</option>
                    <option>Chief Nurse</option>
                    <option>Director of Nursing</option>
                  </optgroup>
                  <optgroup label="Digital & Information Leadership">
                    <option>Chief Digital Information Officer (CDIO)</option>
                    <option>Chief Information Officer (CIO)</option>
                    <option>Chief Nursing Information Officer (CNIO)</option>
                    <option>Chief Clinical Information Officer (CCIO)</option>
                  </optgroup>
                  <optgroup label="Other">
                    <option>Other</option>
                  </optgroup>
                </select>
                <div id="ref_role_other_wrap" class="hidden" style="margin-top:6px;">
                  <input id="ref_role_other" name="ref_role_other"/>
                </div>
              </div>

              <div class="col-2">
                <label for="org">Your organisation (e.g., Barts Health NHS Trust)</label>
                <div class="input-wrapper" id="org-wrapper">
                  <input id="org" name="org" list="trust-list" autocomplete="off"/>
                  <button type="button" class="input-clear-btn" onclick="clearOrgField()">×</button>
                </div>
                <datalist id="trust-list"></datalist>
                <small class="hint">Type to search trusts. Anything after "NHS" will appear as the blue sub-header.</small>
              </div>

              <div class="col-2">
                <label for="hospital_name">Hospital name</label>
                <div class="input-wrapper" id="hospital-wrapper">
                  <input id="hospital_name" name="hospital_name" list="hospital-list" autocomplete="off"/>
                  <button type="button" class="input-clear-btn" onclick="clearHospitalField()">×</button>
                </div>
                <datalist id="hospital-list"></datalist>
                <small class="hint">Type to search hospitals, or enter postcode below</small>
              </div>

              <div class="col-2">
                <label>Hospital address</label>
                <div class="grid">
                  <div><input id="hospital_addr1" name="hospital_addr1" placeholder="Street address"/></div>
                  <div><input id="hospital_addr2" name="hospital_addr2" placeholder="Area (optional)"/></div>
                  <div><input id="hospital_city" name="hospital_city" placeholder="City"/></div>
                  <div>
                    <input id="hospital_postcode" name="hospital_postcode" placeholder="Postcode"/>
                    <small class="hint">Enter postcode to auto-fill hospital details</small>
                  </div>
                </div>
              </div>

              <div class="col-2">
                <label for="ref_email">Your work email</label>
                <input id="ref_email" name="ref_email" type="email" required/>
                <small class="hint">You'll receive a copy of the letter.</small>
              </div>

              <div class="col-2">
                <label for="ref_phone">Your contact number (optional)</label>
                <input id="ref_phone" name="ref_phone" type="tel"/>
              </div>
            </div>

            <div class="actions">
              <button type="button" data-next-step="2">Next</button>
            </div>
          </div>

          <!-- STEP 2A: Custom Letter (for Other Professional Relationship) -->
          <div class="form-step hidden" data-step="2a" id="step-custom-letter">
            <div class="section-title">Your Letter of Support</div>
            <div class="note">
              Since you have a different professional relationship with Alex, please write your own letter of support below.
              Your letter will appear after "Dear NHS Clinical Entrepreneur Team," in the final PDF.
            </div>
            <div class="grid">
              <div class="col-2">
                <label for="custom_letter_text">Your letter content</label>
                <textarea id="custom_letter_text" name="custom_letter_text" style="min-height: 300px;"></textarea>
                <small class="hint">You may wish to include how you know Alex, examples of their work, and why you feel they are suitable for the NHS Clinical Entrepreneur Programme.</small>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="1">Back</button>
              <button type="button" onclick="goToFinalStep()">Next</button>
            </div>
          </div>

          <!-- STEP 2: Relationship & Role -->
          <div class="form-step" data-step="2" id="step-relationship">
            <div class="section-title">Relationship & Role</div>
            <div class="grid">
              <div class="col-2">
                <label for="professional_area">What is your professional relationship to Alex?</label>
                <select id="professional_area" name="professional_area" required>
                  <option value="">Please select...</option>
                  <option value="perioperative">Perioperative/Theatre colleague</option>
                  <option value="different">Other professional relationship</option>
                </select>
              </div>

              <div class="col-2 hidden" id="perioperative_capacity_wrap">
                <label for="relationship">In what capacity have you worked with Alex?</label>
                <select id="relationship" name="relationship">
                  <option value="">Please select...</option>
                  <option>Senior Line Manager</option>
                  <option>Line Manager</option>
                  <option>Senior Clinician</option>
                  <option>Peer / Team Leader</option>
                  <option>Service/Operations Manager</option>
                  <option>Senior Nursing Colleague</option>
                  <option>Senior Clinical Colleague</option>
                  <option>Professional Colleague</option>
                  <option>Clinical Supervisor</option>
                  <option>Senior Clinical Colleague from Locum Assignments</option>
                </select>
              </div>

              <div class="col-2 hidden" id="other_capacity_wrap">
                <label for="other_relationship_capacity">Please specify what capacity you have worked with Alex</label>
                <input id="other_relationship_capacity" name="other_relationship_capacity"/>
                <small class="hint">For example: academic supervisor, digital health collaborator, cross-organisational partner.</small>
              </div>

              <div class="col-2">
                <label for="q_duration_select"><span id="duration_label">How long have you known or worked with Alex?</span></label>
                <select id="q_duration_select" name="q_duration_select" required onchange="toggleDurationDetail()">
                  <option value="">Please select...</option>
                  <option value="less than six months">Less than six months</option>
                  <option value="between six and twelve months">Between six and twelve months</option>
                  <option value="between one and three years">Between one and three years</option>
                  <option value="more than three years">More than three years</option>
                  <option value="other">Other (please add a short description below)</option>
                </select>
                <div id="duration_detail_wrap" class="hidden" style="margin-top:8px;">
                  <input id="q_duration_detail" name="q_duration_detail" placeholder="e.g. Since March 2022, across elective and trauma lists"/>
                  <small class="hint">This will be turned into a narrative sentence in the letter.</small>
                </div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="1">Back</button>
              <button type="button" id="step2-next-button" onclick="handleStep2Next()">Next</button>
            </div>
          </div>

          <!-- STEP 3: NHSCEP DOMAINS -->
          <div class="form-step" data-step="3">
            <div class="section-title">Professional Endorsement Assessment</div>

            <!-- Choice: Custom vs Template -->
            <div class="letter-mode-choice">
              <label class="letter-mode-title">How would you prefer to provide your endorsement?</label>
              <div class="letter-mode-options">
                <label class="letter-mode-option">
                  <input type="radio" name="letter_mode" value="custom" onchange="toggleLetterMode()">
                  <div class="letter-mode-content">
                    <span class="letter-mode-label">Write in my own words</span>
                    <span class="letter-mode-desc">Provide detailed, personalised responses to each assessment area</span>
                  </div>
                </label>
                <label class="letter-mode-option">
                  <input type="radio" name="letter_mode" value="template" checked onchange="toggleLetterMode()">
                  <div class="letter-mode-content">
                    <span class="letter-mode-label">Use guided template</span>
                    <span class="letter-mode-desc">Select from pre-written statements that best match your observations</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- Custom Mode: Free Text Questions -->
            <div id="custom-mode" class="hidden">
              <div class="hint" style="font-size:15px; line-height:1.6; margin-bottom:16px;">
                Please provide your own response to each of the five assessment areas below. Your answers will form the main body of the letter.
              </div>

              <div class="grid">
                <div class="col-2">
                  <label style="font-weight:700; font-size:15px;">Opening Paragraph</label>
                  <label style="font-weight:600; font-size:15px; margin-top:6px;">Please write a brief introduction explaining your professional relationship with Alex and the context in which you have worked together.</label>
                  <textarea id="custom_opening" name="custom_opening" rows="4" placeholder="Example: I am pleased to provide this letter of support for Alex Monterubio. I have worked with Alex for..."></textarea>
                </div>

                <div class="col-2">
                  <label style="font-weight:700; font-size:15px;">1. Personal Motivation</label>
                  <label style="font-weight:600; font-size:15px; margin-top:6px;">What motivates Alex to contribute to improvement and innovation within clinical services?</label>
                  <textarea id="custom_motivation" name="custom_motivation" rows="4" placeholder="Describe Alex's motivation for innovation and improvement..."></textarea>
                </div>

                <div class="col-2">
                  <label style="font-weight:700; font-size:15px;">2. Personal Capability</label>
                  <label style="font-weight:600; font-size:15px; margin-top:6px;">What capabilities does Alex demonstrate in delivering meaningful innovation in a busy clinical setting?</label>
                  <textarea id="custom_capability" name="custom_capability" rows="4" placeholder="Describe Alex's capabilities and skills..."></textarea>
                </div>

                <div class="col-2">
                  <label style="font-weight:700; font-size:15px;">3. Potential Impact</label>
                  <label style="font-weight:600; font-size:15px; margin-top:6px;">What impact could Alex's innovation work have on patient care, staff experience, or service delivery?</label>
                  <textarea id="custom_impact" name="custom_impact" rows="4" placeholder="Describe the potential impact of Alex's work..."></textarea>
                </div>

                <div class="col-2">
                  <label style="font-weight:700; font-size:15px;">4. Alignment with NHS Priorities</label>
                  <label style="font-weight:600; font-size:15px; margin-top:6px;">How do Alex's ideas align with wider NHS priorities and strategic objectives?</label>
                  <textarea id="custom_priority" name="custom_priority" rows="4" placeholder="Describe how Alex's work aligns with NHS priorities..."></textarea>
                </div>

                <div class="col-2">
                  <label style="font-weight:700; font-size:15px;">5. Viability within the NHS</label>
                  <label style="font-weight:600; font-size:15px; margin-top:6px;">How viable and practical is Alex's innovation within the NHS context?</label>
                  <textarea id="custom_viability" name="custom_viability" rows="4" placeholder="Describe the viability of Alex's innovation..."></textarea>
                </div>
              </div>
            </div>

            <!-- Template Mode: Checkbox Selections -->
            <div id="template-mode">
              <div class="hint" style="font-size:15px; line-height:1.6; margin-bottom:16px;">
                Please provide focused feedback in each of the five areas below.<br>
                Select up to <strong>three</strong> statements per section that best reflect your experience of Alex.<br>
                You may add a brief comment if you wish.
              </div>

            <div class="grid">
              <!-- PERSONAL MOTIVATION -->
              <div class="col-2" id="motivation_group">
                <label style="font-weight:700; font-size:15px;">1. Personal Motivation</label>
                <label style="font-weight:600; font-size:15px; margin-top:6px;">What best reflects Alex's motivation for contributing to improvement and innovation within clinical services?</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="a consistent drive to improve perioperative efficiency and theatre workflow">
                    <span>Drive to improve efficiency</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="motivation rooted in day-to-day clinical experience and awareness of operational pressures">
                    <span>Motivated by real clinical pressures</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="a strong desire to streamline communication and coordination across clinical teams">
                    <span>Desire to streamline communication</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="a clear commitment to reducing unnecessary delays, duplication, or waste in patient pathways">
                    <span>Reduce delays and waste</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="a sustained interest in developing digital solutions that directly address frontline challenges">
                    <span>Interest in practical digital solutions</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="a proactive approach to identifying opportunities for service improvement and better resource use">
                    <span>Proactive in spotting improvements</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="motivation" value="a long-term ambition to contribute to modernising systems and pathways within the NHS">
                    <span>Long-term ambition to modernise systems</span>
                  </label>
                </div>
                <input id="motivation_other" name="motivation_other" style="margin-top:8px;" placeholder="Other (free text) – add in your own words"/>
              </div>

              <!-- PERSONAL CAPABILITY -->
              <div class="col-2" id="capability_group">
                <label style="font-weight:700; font-size:15px;">2. Personal Capability</label>
                <label style="font-weight:600; font-size:15px; margin-top:6px;">What best reflects Alex's capability to deliver meaningful innovation in a busy clinical setting?</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="the ability to interpret operational issues and translate them into workable solutions">
                    <span>Translates operational issues into solutions</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="effective communication with multidisciplinary teams, even in high-pressure settings">
                    <span>Communicates effectively with MDTs</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="leadership behaviours that support team coordination and safe decision-making">
                    <span>Shows supportive leadership behaviours</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="a reflective and feedback-responsive approach, adjusting practice when required">
                    <span>Reflective and responsive to feedback</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="resilience and determination when progressing complex improvement work">
                    <span>Resilient when work is complex</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="the ability to balance clinical duties with project development and strategic thinking">
                    <span>Balances clinical work with projects</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="capability" value="an understanding of data, workflow, and system patterns relevant to service improvement">
                    <span>Understands data and workflows</span>
                  </label>
                </div>
                <input id="capability_other" name="capability_other" style="margin-top:8px;" placeholder="Other (free text) – add in your own words"/>
              </div>

              <!-- CLINICAL IMPACT -->
              <div class="col-2" id="impact_group">
                <label style="font-weight:700; font-size:15px;">3. Clinical Impact</label>
                <label style="font-weight:600; font-size:15px; margin-top:6px;">In your view, how might Alex's innovation work benefit patients, teams, or the wider service?</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="improve theatre utilisation and reduce avoidable downtime">
                    <span>Improve theatre utilisation</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="enhance communication and coordination across teams and roles">
                    <span>Enhance team communication/coordination</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="strengthen patient safety through clearer oversight and escalation pathways">
                    <span>Strengthen patient safety</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="reduce operational bottlenecks affecting elective and trauma pathways">
                    <span>Reduce operational bottlenecks</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="improve the reliability and predictability of daily workflows">
                    <span>Improve reliability of daily workflows</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="support more consistent and efficient allocation of staff and resources">
                    <span>Support efficient staff/resource allocation</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="impact" value="deliver measurable improvements in productivity and quality of care">
                    <span>Deliver measurable improvements</span>
                  </label>
                </div>
                <input id="impact_other" name="impact_other" style="margin-top:8px;" placeholder="Other (free text) – add in your own words"/>
              </div>

              <!-- PRIORITY TO THE NHS -->
              <div class="col-2" id="priority_group">
                <label style="font-weight:700; font-size:15px;">4. Priority to the NHS</label>
                <label style="font-weight:600; font-size:15px; margin-top:6px;">How do Alex's ideas or approach align with wider NHS priorities?</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="support elective recovery and improved surgical throughput">
                    <span>Supports elective recovery</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="align with priorities in digital transformation and smarter workflow systems">
                    <span>Aligns with digital transformation</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="address workforce efficiency and operational sustainability">
                    <span>Addresses workforce efficiency</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="encourage better use of real-time data to support decision-making">
                    <span>Promotes better use of real-time data</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="contribute to patient safety, quality, and reduction of unwarranted variation">
                    <span>Contributes to safety and quality</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="support long-term system goals across pathways and integrated care">
                    <span>Supports long-term system goals</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="priority" value="help improve value for money through reduced delays or duplication">
                    <span>Improves value for money</span>
                  </label>
                </div>
                <input id="priority_other" name="priority_other" style="margin-top:8px;" placeholder="Other (free text) – add in your own words"/>
              </div>

              <!-- VIABILITY OF THE INNOVATION -->
              <div class="col-2" id="viability_group">
                <label style="font-weight:700; font-size:15px;">5. Viability of the Innovation</label>
                <label style="font-weight:600; font-size:15px; margin-top:6px;">How viable do you consider Alex's innovation to be within the NHS setting?</label>
                <div class="grid">
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="grounded in real operational needs and frontline experience">
                    <span>Grounded in real operational needs</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="likely to be well received by clinical teams due to its relevance and practicality">
                    <span>Likely to be well received by teams</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="already demonstrating potential to improve efficiency or safety at an early stage">
                    <span>Shows early potential for improvement</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="shaped through Alex’s willingness to iterate ideas based on feedback and evidence">
                    <span>Iterated based on feedback/evidence</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="compatible with existing workflows and digital systems in principle">
                    <span>Compatible with existing workflows</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="having potential scalability beyond a single department or site">
                    <span>Potentially scalable across sites</span>
                  </label>
                  <label class="inline-option">
                    <input type="checkbox" name="viability" value="demonstrating potential for long-term cost-effectiveness and sustainability">
                    <span>Potential long-term cost-effectiveness</span>
                  </label>
                </div>
                <input id="viability_other" name="viability_other" style="margin-top:8px;" placeholder="Other (free text) – add in your own words"/>
              </div>
            </div>

            </div><!-- End template-mode -->

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="2">Back</button>
              <button type="button" data-next-step="4">Next</button>
            </div>
          </div>

          <!-- STEP 4 -->
          <div class="form-step" data-step="4">
            <div class="section-title">Date & Signature</div>
            <div class="grid">
              <div class="col-2">
                <label for="date_line">Letter date</label>
                <input id="date_line" name="date_line"/>
                <small class="hint">Today's date is pre-filled. You can change it if needed.</small>
              </div>
            </div>

            <div class="section-title">Sign Your Letter</div>
            <div class="col-2">
              <label style="font-weight:600; font-size:15px; color:#0f172a; margin-bottom:8px; display:block;">
                ✍️ Electronic Signature
              </label>
              <p style="margin:0 0 12px 0; font-size:13px; color:#64748b; line-height:1.6;">
                Please sign below using your mouse, trackpad, or touchscreen to complete your endorsement.
              </p>
              <div class="sig-wrap">
                <div style="position:relative;">
                  <canvas id="signature-canvas" class="sig-canvas"></canvas>
                  <div id="sig-watermark" class="sig-watermark">Sign Here</div>
                </div>
                <div class="sig-row">
                  <div class="sig-actions">
                    <button type="button" id="clear-signature-btn" class="ghost" style="font-size:13px; padding:6px 12px;">🔄 Clear Signature</button>
                  </div>
                  <small class="hint" style="color:#64748b; font-size:12px;">Your signature will be securely embedded in the PDF</small>
                </div>
              </div>
            </div>

            <div style="margin-top:16px; padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px;">
              <label style="display:flex; align-items:start; gap:10px; margin:0;">
                <input type="checkbox" required style="width:auto; margin-top:3px;"/>
                <span style="flex:1;">I confirm this endorsement is accurate and I'm happy for it to be submitted to Alex Monterubio for the NHS Clinical Entrepreneur Programme.</span>
              </label>
            </div>

            <div class="section-title">Submit Your Letter</div>

            <!-- Status message for submission animation -->
            <div id="submit-status" class="submit-status"></div>

            <div class="actions">
              <button type="button" class="secondary" data-prev-step="3">Back</button>
              <button type="button" id="submit-btn" onclick="emailLetter()">Send Letter</button>
              <button type="button" class="ghost" onclick="updatePreview()">Refresh Preview</button>
            </div>
            <small class="hint">Sends the signed letter to your email and Alex's email.</small>
          </div>
        </form>
      </div>

      <!-- RIGHT: PREVIEW -->
      <div class="panel">
        <div class="preview-wrap">
          <div id="preview"></div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <h4>Letter sent successfully!</h4>
    <p>Your signed letter of support has been emailed to you and to Alex Monterubio.</p>
    <p>Thank you for your endorsement!</p>
    <p><em>— With appreciation, MEDASKCA Team</em></p>
  </div>

  <!-- Loading overlay with animated logo -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <img src="logo-medaskca.png" alt="MEDASKCA" class="loading-logo">
      <div class="loading-text">
        <div class="loading-title">Processing your endorsement</div>
        <div class="loading-subtitle">Generating PDF and sending email...</div>
      </div>
    </div>
  </div>

  <!-- Analytics Tracking Script (invisible) -->
  <script>
  (function() {
    // Only track in production (not local dev)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return;
    }

    // Webhook endpoint - replace this with your own webhook URL
    const WEBHOOK_URL = 'YOUR_WEBHOOK_URL_HERE';

    async function trackPageView() {
      try {
        // Get visitor geo/IP data from free API
        const geoResponse = await fetch('https://ipapi.co/json/');
        const geoData = await geoResponse.json();

        // Prepare tracking data
        const trackingData = {
          timestamp: new Date().toISOString(),
          page_url: window.location.href,
          referrer: document.referrer || 'Direct',
          ip_address: geoData.ip || 'Unknown',
          country: geoData.country_name || 'Unknown',
          city: geoData.city || 'Unknown',
          region: geoData.region || 'Unknown',
          postal_code: geoData.postal || 'Unknown',
          latitude: geoData.latitude || null,
          longitude: geoData.longitude || null,
          timezone: geoData.timezone || 'Unknown',
          isp: geoData.org || 'Unknown',
          user_agent: navigator.userAgent,
          screen_resolution: `${screen.width}x${screen.height}`,
          language: navigator.language || 'Unknown',
          platform: navigator.platform || 'Unknown'
        };

        // Send to webhook if URL is configured
        if (WEBHOOK_URL && WEBHOOK_URL !== 'YOUR_WEBHOOK_URL_HERE') {
          await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(trackingData),
            mode: 'no-cors' // Avoid CORS issues
          });
        }

        // Also store locally for dashboard viewing
        const visits = JSON.parse(localStorage.getItem('analytics_visits') || '[]');
        visits.unshift(trackingData);
        // Keep last 100 visits
        if (visits.length > 100) visits.length = 100;
        localStorage.setItem('analytics_visits', JSON.stringify(visits));

      } catch (error) {
        console.error('Analytics tracking error:', error);
      }
    }

    // Track page view on load
    if (document.readyState === 'complete') {
      trackPageView();
    } else {
      window.addEventListener('load', trackPageView);
    }
  })();
  </script>
</body>
</html>
